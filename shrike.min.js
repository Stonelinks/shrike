(function(){var n=this,t=n._,r={},e=Array.prototype,i=Object.prototype,a=Function.prototype,o=e.push,u=e.slice,l=e.concat,s=i.toString,c=i.hasOwnProperty,f=e.forEach,h=e.map,g=e.reduce,d=e.reduceRight,v=e.filter,m=e.every,p=e.some,y=e.indexOf,M=e.lastIndexOf,w=Array.isArray,x=Object.keys,F=a.bind,b=function(n){return n instanceof b?n:this instanceof b?(this._wrapped=n,void 0):new b(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=b),exports._=b):n._=b,b.VERSION="1.6.0";var A=b.each=b.forEach=function(n,t,e){if(null==n)return n;if(f&&n.forEach===f)n.forEach(t,e);else if(n.length===+n.length){for(var i=0,a=n.length;a>i;i++)if(t.call(e,n[i],i,n)===r)return}else for(var o=b.keys(n),i=0,a=o.length;a>i;i++)if(t.call(e,n[o[i]],o[i],n)===r)return;return n};b.map=b.collect=function(n,t,r){var e=[];return null==n?e:h&&n.map===h?n.map(t,r):(A(n,function(n,i,a){e.push(t.call(r,n,i,a))}),e)};var _="Reduce of empty array with no initial value";b.reduce=b.foldl=b.inject=function(n,t,r,e){var i=arguments.length>2;if(null==n&&(n=[]),g&&n.reduce===g)return e&&(t=b.bind(t,e)),i?n.reduce(t,r):n.reduce(t);if(A(n,function(n,a,o){i?r=t.call(e,r,n,a,o):(r=n,i=!0)}),!i)throw new TypeError(_);return r},b.reduceRight=b.foldr=function(n,t,r,e){var i=arguments.length>2;if(null==n&&(n=[]),d&&n.reduceRight===d)return e&&(t=b.bind(t,e)),i?n.reduceRight(t,r):n.reduceRight(t);var a=n.length;if(a!==+a){var o=b.keys(n);a=o.length}if(A(n,function(u,l,s){l=o?o[--a]:--a,i?r=t.call(e,r,n[l],l,s):(r=n[l],i=!0)}),!i)throw new TypeError(_);return r},b.find=b.detect=function(n,t,r){var e;return j(n,function(n,i,a){return t.call(r,n,i,a)?(e=n,!0):void 0}),e},b.filter=b.select=function(n,t,r){var e=[];return null==n?e:v&&n.filter===v?n.filter(t,r):(A(n,function(n,i,a){t.call(r,n,i,a)&&e.push(n)}),e)},b.reject=function(n,t,r){return b.filter(n,function(n,e,i){return!t.call(r,n,e,i)},r)},b.every=b.all=function(n,t,e){t||(t=b.identity);var i=!0;return null==n?i:m&&n.every===m?n.every(t,e):(A(n,function(n,a,o){return(i=i&&t.call(e,n,a,o))?void 0:r}),!!i)};var j=b.some=b.any=function(n,t,e){t||(t=b.identity);var i=!1;return null==n?i:p&&n.some===p?n.some(t,e):(A(n,function(n,a,o){return i||(i=t.call(e,n,a,o))?r:void 0}),!!i)};b.contains=b.include=function(n,t){return null==n?!1:y&&n.indexOf===y?-1!=n.indexOf(t):j(n,function(n){return n===t})},b.invoke=function(n,t){var r=u.call(arguments,2),e=b.isFunction(t);return b.map(n,function(n){return(e?t:n[t]).apply(n,r)})},b.pluck=function(n,t){return b.map(n,b.property(t))},b.where=function(n,t){return b.filter(n,b.matches(t))},b.findWhere=function(n,t){return b.find(n,b.matches(t))},b.max=function(n,t,r){if(!t&&b.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.max.apply(Math,n);var e=-1/0,i=-1/0;return A(n,function(n,a,o){var u=t?t.call(r,n,a,o):n;u>i&&(e=n,i=u)}),e},b.min=function(n,t,r){if(!t&&b.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.min.apply(Math,n);var e=1/0,i=1/0;return A(n,function(n,a,o){var u=t?t.call(r,n,a,o):n;i>u&&(e=n,i=u)}),e},b.shuffle=function(n){var t,r=0,e=[];return A(n,function(n){t=b.random(r++),e[r-1]=e[t],e[t]=n}),e},b.sample=function(n,t,r){return null==t||r?(n.length!==+n.length&&(n=b.values(n)),n[b.random(n.length-1)]):b.shuffle(n).slice(0,Math.max(0,t))};var k=function(n){return null==n?b.identity:b.isFunction(n)?n:b.property(n)};b.sortBy=function(n,t,r){return t=k(t),b.pluck(b.map(n,function(n,e,i){return{value:n,index:e,criteria:t.call(r,n,e,i)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||void 0===r)return 1;if(e>r||void 0===e)return-1}return n.index-t.index}),"value")};var O=function(n){return function(t,r,e){var i={};return r=k(r),A(t,function(a,o){var u=r.call(e,a,o,t);n(i,u,a)}),i}};b.groupBy=O(function(n,t,r){b.has(n,t)?n[t].push(r):n[t]=[r]}),b.indexBy=O(function(n,t,r){n[t]=r}),b.countBy=O(function(n,t){b.has(n,t)?n[t]++:n[t]=1}),b.sortedIndex=function(n,t,r,e){r=k(r);for(var i=r.call(e,t),a=0,o=n.length;o>a;){var u=a+o>>>1;r.call(e,n[u])<i?a=u+1:o=u}return a},b.toArray=function(n){return n?b.isArray(n)?u.call(n):n.length===+n.length?b.map(n,b.identity):b.values(n):[]},b.size=function(n){return null==n?0:n.length===+n.length?n.length:b.keys(n).length},b.first=b.head=b.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:0>t?[]:u.call(n,0,t)},b.initial=function(n,t,r){return u.call(n,0,n.length-(null==t||r?1:t))},b.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:u.call(n,Math.max(n.length-t,0))},b.rest=b.tail=b.drop=function(n,t,r){return u.call(n,null==t||r?1:t)},b.compact=function(n){return b.filter(n,b.identity)};var E=function(n,t,r){return t&&b.every(n,b.isArray)?l.apply(r,n):(A(n,function(n){b.isArray(n)||b.isArguments(n)?t?o.apply(r,n):E(n,t,r):r.push(n)}),r)};b.flatten=function(n,t){return E(n,t,[])},b.without=function(n){return b.difference(n,u.call(arguments,1))},b.partition=function(n,t){var r=[],e=[];return A(n,function(n){(t(n)?r:e).push(n)}),[r,e]},b.uniq=b.unique=function(n,t,r,e){b.isFunction(t)&&(e=r,r=t,t=!1);var i=r?b.map(n,r,e):n,a=[],o=[];return A(i,function(r,e){(t?e&&o[o.length-1]===r:b.contains(o,r))||(o.push(r),a.push(n[e]))}),a},b.union=function(){return b.uniq(b.flatten(arguments,!0))},b.intersection=function(n){var t=u.call(arguments,1);return b.filter(b.uniq(n),function(n){return b.every(t,function(t){return b.contains(t,n)})})},b.difference=function(n){var t=l.apply(e,u.call(arguments,1));return b.filter(n,function(n){return!b.contains(t,n)})},b.zip=function(){for(var n=b.max(b.pluck(arguments,"length").concat(0)),t=new Array(n),r=0;n>r;r++)t[r]=b.pluck(arguments,""+r);return t},b.object=function(n,t){if(null==n)return{};for(var r={},e=0,i=n.length;i>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},b.indexOf=function(n,t,r){if(null==n)return-1;var e=0,i=n.length;if(r){if("number"!=typeof r)return e=b.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,i+r):r}if(y&&n.indexOf===y)return n.indexOf(t,r);for(;i>e;e++)if(n[e]===t)return e;return-1},b.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=null!=r;if(M&&n.lastIndexOf===M)return e?n.lastIndexOf(t,r):n.lastIndexOf(t);for(var i=e?r:n.length;i--;)if(n[i]===t)return i;return-1},b.range=function(n,t,r){arguments.length<=1&&(t=n||0,n=0),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n)/r),0),i=0,a=new Array(e);e>i;)a[i++]=n,n+=r;return a};var q=function(){};b.bind=function(n,t){var r,e;if(F&&n.bind===F)return F.apply(n,u.call(arguments,1));if(!b.isFunction(n))throw new TypeError;return r=u.call(arguments,2),e=function(){if(!(this instanceof e))return n.apply(t,r.concat(u.call(arguments)));q.prototype=n.prototype;var i=new q;q.prototype=null;var a=n.apply(i,r.concat(u.call(arguments)));return Object(a)===a?a:i}},b.partial=function(n){var t=u.call(arguments,1);return function(){for(var r=0,e=t.slice(),i=0,a=e.length;a>i;i++)e[i]===b&&(e[i]=arguments[r++]);for(;r<arguments.length;)e.push(arguments[r++]);return n.apply(this,e)}},b.bindAll=function(n){var t=u.call(arguments,1);if(0===t.length)throw new Error("bindAll must be passed function names");return A(t,function(t){n[t]=b.bind(n[t],n)}),n},b.memoize=function(n,t){var r={};return t||(t=b.identity),function(){var e=t.apply(this,arguments);return b.has(r,e)?r[e]:r[e]=n.apply(this,arguments)}},b.delay=function(n,t){var r=u.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},b.defer=function(n){return b.delay.apply(b,[n,1].concat(u.call(arguments,1)))},b.throttle=function(n,t,r){var e,i,a,o=null,u=0;r||(r={});var l=function(){u=r.leading===!1?0:b.now(),o=null,a=n.apply(e,i),e=i=null};return function(){var s=b.now();u||r.leading!==!1||(u=s);var c=t-(s-u);return e=this,i=arguments,0>=c?(clearTimeout(o),o=null,u=s,a=n.apply(e,i),e=i=null):o||r.trailing===!1||(o=setTimeout(l,c)),a}},b.debounce=function(n,t,r){var e,i,a,o,u,l=function(){var s=b.now()-o;t>s?e=setTimeout(l,t-s):(e=null,r||(u=n.apply(a,i),a=i=null))};return function(){a=this,i=arguments,o=b.now();var s=r&&!e;return e||(e=setTimeout(l,t)),s&&(u=n.apply(a,i),a=i=null),u}},b.once=function(n){var t,r=!1;return function(){return r?t:(r=!0,t=n.apply(this,arguments),n=null,t)}},b.wrap=function(n,t){return b.partial(t,n)},b.compose=function(){var n=arguments;return function(){for(var t=arguments,r=n.length-1;r>=0;r--)t=[n[r].apply(this,t)];return t[0]}},b.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},b.keys=function(n){if(!b.isObject(n))return[];if(x)return x(n);var t=[];for(var r in n)b.has(n,r)&&t.push(r);return t},b.values=function(n){for(var t=b.keys(n),r=t.length,e=new Array(r),i=0;r>i;i++)e[i]=n[t[i]];return e},b.pairs=function(n){for(var t=b.keys(n),r=t.length,e=new Array(r),i=0;r>i;i++)e[i]=[t[i],n[t[i]]];return e},b.invert=function(n){for(var t={},r=b.keys(n),e=0,i=r.length;i>e;e++)t[n[r[e]]]=r[e];return t},b.functions=b.methods=function(n){var t=[];for(var r in n)b.isFunction(n[r])&&t.push(r);return t.sort()},b.extend=function(n){return A(u.call(arguments,1),function(t){if(t)for(var r in t)n[r]=t[r]}),n},b.pick=function(n){var t={},r=l.apply(e,u.call(arguments,1));return A(r,function(r){r in n&&(t[r]=n[r])}),t},b.omit=function(n){var t={},r=l.apply(e,u.call(arguments,1));for(var i in n)b.contains(r,i)||(t[i]=n[i]);return t},b.defaults=function(n){return A(u.call(arguments,1),function(t){if(t)for(var r in t)void 0===n[r]&&(n[r]=t[r])}),n},b.clone=function(n){return b.isObject(n)?b.isArray(n)?n.slice():b.extend({},n):n},b.tap=function(n,t){return t(n),n};var N=function(n,t,r,e){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;n instanceof b&&(n=n._wrapped),t instanceof b&&(t=t._wrapped);var i=s.call(n);if(i!=s.call(t))return!1;switch(i){case"[object String]":return n==String(t);case"[object Number]":return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case"[object Date]":case"[object Boolean]":return+n==+t;case"[object RegExp]":return n.source==t.source&&n.global==t.global&&n.multiline==t.multiline&&n.ignoreCase==t.ignoreCase}if("object"!=typeof n||"object"!=typeof t)return!1;for(var a=r.length;a--;)if(r[a]==n)return e[a]==t;var o=n.constructor,u=t.constructor;if(o!==u&&!(b.isFunction(o)&&o instanceof o&&b.isFunction(u)&&u instanceof u)&&"constructor"in n&&"constructor"in t)return!1;r.push(n),e.push(t);var l=0,c=!0;if("[object Array]"==i){if(l=n.length,c=l==t.length)for(;l--&&(c=N(n[l],t[l],r,e)););}else{for(var f in n)if(b.has(n,f)&&(l++,!(c=b.has(t,f)&&N(n[f],t[f],r,e))))break;if(c){for(f in t)if(b.has(t,f)&&!l--)break;c=!l}}return r.pop(),e.pop(),c};b.isEqual=function(n,t){return N(n,t,[],[])},b.isEmpty=function(n){if(null==n)return!0;if(b.isArray(n)||b.isString(n))return 0===n.length;for(var t in n)if(b.has(n,t))return!1;return!0},b.isElement=function(n){return!(!n||1!==n.nodeType)},b.isArray=w||function(n){return"[object Array]"==s.call(n)},b.isObject=function(n){return n===Object(n)},A(["Arguments","Function","String","Number","Date","RegExp"],function(n){b["is"+n]=function(t){return s.call(t)=="[object "+n+"]"}}),b.isArguments(arguments)||(b.isArguments=function(n){return!(!n||!b.has(n,"callee"))}),"function"!=typeof/./&&(b.isFunction=function(n){return"function"==typeof n}),b.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},b.isNaN=function(n){return b.isNumber(n)&&n!=+n},b.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==s.call(n)},b.isNull=function(n){return null===n},b.isUndefined=function(n){return void 0===n},b.has=function(n,t){return c.call(n,t)},b.noConflict=function(){return n._=t,this},b.identity=function(n){return n},b.constant=function(n){return function(){return n}},b.property=function(n){return function(t){return t[n]}},b.matches=function(n){return function(t){if(t===n)return!0;for(var r in n)if(n[r]!==t[r])return!1;return!0}},b.times=function(n,t,r){for(var e=Array(Math.max(0,n)),i=0;n>i;i++)e[i]=t.call(r,i);return e},b.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},b.now=Date.now||function(){return(new Date).getTime()};var I={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};I.unescape=b.invert(I.escape);var T={escape:new RegExp("["+b.keys(I.escape).join("")+"]","g"),unescape:new RegExp("("+b.keys(I.unescape).join("|")+")","g")};b.each(["escape","unescape"],function(n){b[n]=function(t){return null==t?"":(""+t).replace(T[n],function(t){return I[n][t]})}}),b.result=function(n,t){if(null==n)return void 0;var r=n[t];return b.isFunction(r)?r.call(n):r},b.mixin=function(n){A(b.functions(n),function(t){var r=b[t]=n[t];b.prototype[t]=function(){var n=[this._wrapped];return o.apply(n,arguments),D.call(this,r.apply(b,n))}})};var R=0;b.uniqueId=function(n){var t=++R+"";return n?n+t:t},b.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var S=/(.)^/,z={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},P=/\\|'|\r|\n|\t|\u2028|\u2029/g;b.template=function(n,t,r){var e;r=b.defaults({},r,b.templateSettings);var i=new RegExp([(r.escape||S).source,(r.interpolate||S).source,(r.evaluate||S).source].join("|")+"|$","g"),a=0,o="__p+='";n.replace(i,function(t,r,e,i,u){return o+=n.slice(a,u).replace(P,function(n){return"\\"+z[n]}),r&&(o+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),e&&(o+="'+\n((__t=("+e+"))==null?'':__t)+\n'"),i&&(o+="';\n"+i+"\n__p+='"),a=u+t.length,t}),o+="';\n",r.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{e=new Function(r.variable||"obj","_",o)}catch(u){throw u.source=o,u}if(t)return e(t,b);var l=function(n){return e.call(this,n,b)};return l.source="function("+(r.variable||"obj")+"){\n"+o+"}",l},b.chain=function(n){return b(n).chain()};var D=function(n){return this._chain?b(n).chain():n};b.mixin(b),A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=e[n];b.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=n&&"splice"!=n||0!==r.length||delete r[0],D.call(this,r)}}),A(["concat","join","slice"],function(n){var t=e[n];b.prototype[n]=function(){return D.call(this,t.apply(this._wrapped,arguments))}}),b.extend(b.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return b})}).call(this),define("utils",["underscore"],function(n){return window.pass=window.pass||function(){},function(t){t.throwError=function(n){throw n=n||"undefined error",new Error("SHRIKE: "+n)};var r=!0;t.assert=r&&(window.hasOwnProperty("DEBUG")?window.DEBUG:r)?function(n,r){n||t.throwError(r)}:window.pass,t.register=function(r,e){var i=r.split(".").reverse();if(1==i.length)t.assert(!t.hasOwnProperty(r),"shrike already has a "+r),t[r]=e;else for(var a=i[0],o=t;i.length>0;){var u=i.pop();t.assert(!(o.hasOwnProperty(u)&&!n.isObject(o[u])),"shrike already has a "+r),u===a?o[u]=e:(n.isObject(o[u])||(o[u]={}),o=o[u])}},t.alias=function(n,r){t.assert(t.hasOwnProperty(r),"shrike doesn't have a "+r+" to alias"),t.register(n,t[r])},t.register("isArray",function(r){return n.isArray(r)?!0:t.isNativeFloatArray(r)}),t.register("isNativeFloatArray",function(t){try{return n.isArray(t)!==!0&&"Array]"==Object.prototype.toString.call(t).slice(-"Array]".length)}catch(r){return!1}}),t.register("is2DArray",function(r){return t.isArray(r)?t.isNativeFloatArray(r)?!1:0===r.length?!1:n.some(n.map(r,t.isArray)):!1}),t.register("isNumber",function(n){return!isNaN(parseFloat(n))&&isFinite(n)&&!t.isArray(n)}),t.register("prettyPrint",function(r){console.log(function(){if(t.isArray(r)){if(t.is2DArray(r)){for(var e=6,i=0,a=0;a<r.length;a++)for(var o=0;o<r[a].length;o++)t.assert(!n.isString(r[a][o]),"prettyPrint: there is a string in this matrix, you should fix that"),t.round(r[a][o],e).toString().length>i&&(i=t.round(r[a][o],e).toString().length);for(var u=[],l=void 0,a=0;a<r.length;a++){for(var s=[],o=0;o<r[a].length;o++){for(var c=t.round(r[a][o],e).toString(),f=i-c.length,h="",g="",d=0;f>d;d++)d>=f/2?h+=" ":g+=" ";s.push(h+c+g)}if(u.push(s),void 0===l){for(var v=[],m="",d=0;i>d;d++)m+="-";for(var d=0;d<s.length;d++)v.push(m);l="+-"+v.join("-+-")+"-+"}}for(var p=l+"\n",a=0;a<r.length;a++){var s=u[a],y="| "+s.join(" | ")+" |";p+=y+"\n",p+=l+"\n"}return p}var p="[ "+new Array(r).join(", ")+" ]";return p}return r}())}),window.pp=t.prettyPrint}}),define("iterators",["underscore"],function(n){return function(t){t.register("scalarIterator",function(r,e){if(e=e||pass,t.is2DArray(r))return n.map(r,function(t){return n.map(t,e)});if(t.isArray(r)){if(t.isNativeFloatArray(r)){for(var i=new t.FLOAT_ARRAY_TYPE(r.length),a=0;a<r.length;a++)i[a]=e(r[a]);return i}return n.map(r,e)}return e(r)})}}),define("mjs",[],function(){function n(n,t){if(!n)throw"Assertion failed: "+t}function n(){}const t=Float64Array;var e={};e._temp1=new t(3),e._temp2=new t(3),e._temp3=new t(3),t==Array?(e.x=[1,0,0],e.y=[0,1,0],e.z=[0,0,1],e.$=function(n,t,r){return[n,t,r]},e.clone=function(t){return n(3==t.length,"a.length == 3"),[t[0],t[1],t[2]]}):(e.x=new t([1,0,0]),e.y=new t([0,1,0]),e.z=new t([0,0,1]),e.$=function(n,r,e){return new t([n,r,e])},e.clone=function(r){return n(3==r.length,"a.length == 3"),new t(r)}),e.u=e.x,e.v=e.y,e.add=function(r,e,i){return n(3==r.length,"a.length == 3"),n(3==e.length,"b.length == 3"),n(void 0==i||3==i.length,"r == undefined || r.length == 3"),void 0==i&&(i=new t(3)),i[0]=r[0]+e[0],i[1]=r[1]+e[1],i[2]=r[2]+e[2],i},e.sub=function(r,e,i){return n(3==r.length,"a.length == 3"),n(3==e.length,"b.length == 3"),n(void 0==i||3==i.length,"r == undefined || r.length == 3"),void 0==i&&(i=new t(3)),i[0]=r[0]-e[0],i[1]=r[1]-e[1],i[2]=r[2]-e[2],i},e.neg=function(r,e){return n(3==r.length,"a.length == 3"),n(void 0==e||3==e.length,"r == undefined || r.length == 3"),void 0==e&&(e=new t(3)),e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e},e.direction=function(r,i,a){return n(3==r.length,"a.length == 3"),n(3==i.length,"b.length == 3"),n(void 0==a||3==a.length,"r == undefined || r.length == 3"),void 0==a&&(a=new t(3)),e.normalize(e.sub(r,i,a),a)},e.length=function(t){return n(3==t.length,"a.length == 3"),Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},e.lengthSquared=function(t){return n(3==t.length,"a.length == 3"),t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},e.normalize=function(r,i){n(3==r.length,"a.length == 3"),n(void 0==i||3==i.length,"r == undefined || r.length == 3"),void 0==i&&(i=new t(3));var a=1/e.length(r);return i[0]=r[0]*a,i[1]=r[1]*a,i[2]=r[2]*a,i},e.scale=function(r,e,i){return n(3==r.length,"a.length == 3"),n(void 0==i||3==i.length,"r == undefined || r.length == 3"),void 0==i&&(i=new t(3)),i[0]=r[0]*e,i[1]=r[1]*e,i[2]=r[2]*e,i},e.dot=function(t,r){return n(3==t.length,"a.length == 3"),n(3==r.length,"b.length == 3"),t[0]*r[0]+t[1]*r[1]+t[2]*r[2]},e.cross=function(r,e,i){return n(3==r.length,"a.length == 3"),n(3==e.length,"b.length == 3"),n(void 0==i||3==i.length,"r == undefined || r.length == 3"),void 0==i&&(i=new t(3)),i[0]=r[1]*e[2]-r[2]*e[1],i[1]=r[2]*e[0]-r[0]*e[2],i[2]=r[0]*e[1]-r[1]*e[0],i},e.mul4x4=function(r,i,a){n(16==r.length,"m.length == 16"),n(3==i.length,"v.length == 3"),n(void 0==a||3==a.length,"r == undefined || r.length == 3");var o,u=e._temp1;return void 0==a&&(a=new t(3)),u[0]=r[3],u[1]=r[7],u[2]=r[11],o=e.dot(i,u)+r[15],u[0]=r[0],u[1]=r[4],u[2]=r[8],a[0]=(e.dot(i,u)+r[12])/o,u[0]=r[1],u[1]=r[5],u[2]=r[9],a[1]=(e.dot(i,u)+r[13])/o,u[0]=r[2],u[1]=r[6],u[2]=r[10],a[2]=(e.dot(i,u)+r[14])/o,a};var i={};i._temp1=new t(16),i._temp2=new t(16),t==Array?(i.I=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],i.$=function(n,t,r,e,i,a,o,u,l,s,c,f,h,g,d,v){return[n,t,r,e,i,a,o,u,l,s,c,f,h,g,d,v]},i.clone=function(t){return n(16==t.length,"m.length == 16"),new[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]}):(i.I=new t([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),i.$=function(n,r,e,i,a,o,u,l,s,c,f,h,g,d,v,m){return new t([n,r,e,i,a,o,u,l,s,c,f,h,g,d,v,m])},i.clone=function(r){return n(16==r.length,"m.length == 16"),new t(r)}),i.identity=i.I,i.topLeft3x3=function(r,e){return n(16==r.length,"m.length == 16"),n(void 0==e||9==e.length,"r == undefined || r.length == 9"),void 0==e&&(e=new t(9)),e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[4],e[4]=r[5],e[5]=r[6],e[6]=r[8],e[7]=r[9],e[8]=r[10],e},i.inverseOrthonormal=function(r,a){n(16==r.length,"m.length == 16"),n(void 0==a||16==a.length,"r == undefined || r.length == 16"),n(r!=a,"m != r"),void 0==a&&(a=new t(16)),i.transpose(r,a);var o=[r[12],r[13],r[14]];return a[3]=a[7]=a[11]=0,a[12]=-e.dot([a[0],a[4],a[8]],o),a[13]=-e.dot([a[1],a[5],a[9]],o),a[14]=-e.dot([a[2],a[6],a[10]],o),a},i.inverseTo3x3=function(r,e){n(16==r.length,"m.length == 16"),n(void 0==e||9==e.length,"r == undefined || r.length == 9"),void 0==e&&(e=new t(9));var i=r[10]*r[5]-r[6]*r[9],a=-r[10]*r[1]+r[2]*r[9],o=r[6]*r[1]-r[2]*r[5],u=-r[10]*r[4]+r[6]*r[8],l=r[10]*r[0]-r[2]*r[8],s=-r[6]*r[0]+r[2]*r[4],c=r[9]*r[4]-r[5]*r[8],f=-r[9]*r[0]+r[1]*r[8],h=r[5]*r[0]-r[1]*r[4],g=r[0]*i+r[1]*u+r[2]*c;if(0==g)throw"matrix not invertible";var d=1/g;return e[0]=d*i,e[1]=d*a,e[2]=d*o,e[3]=d*u,e[4]=d*l,e[5]=d*s,e[6]=d*c,e[7]=d*f,e[8]=d*h,e},i.makeFrustum=function(r,e,i,a,o,u,l){n(void 0==l||16==l.length,"r == undefined || r.length == 16"),void 0==l&&(l=new t(16));return l[0]=2*o/(e-r),l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=2*o/(a-i),l[6]=0,l[7]=0,l[8]=(e+r)/(e-r),l[9]=(a+i)/(a-i),l[10]=-(u+o)/(u-o),l[11]=-1,l[12]=0,l[13]=0,l[14]=-2*u*o/(u-o),l[15]=0,l},i.makePerspective=function(t,r,e,a,o){n(void 0==o||16==o.length,"r == undefined || r.length == 16");var u=e*Math.tan(t*Math.PI/360),l=-u,s=l*r,c=u*r;return i.makeFrustum(s,c,l,u,e,a,o)},i.makeOrtho=function(r,e,i,a,o,u,l){n(void 0==l||16==l.length,"r == undefined || r.length == 16"),void 0==l&&(l=new t(16));return l[0]=2/(e-r),l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=2/(a-i),l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=-2/(u-o),l[11]=0,l[12]=-(e+r)/(e-r),l[13]=-(a+i)/(a-i),l[14]=-(u+o)/(u-o),l[15]=1,l},i.makeOrtho2D=function(t,r,e,a,o){return n(void 0==o||16==o.length,"r == undefined || r.length == 16"),i.makeOrtho(t,r,e,a,-1,1,o)},i.mul=function(r,e,i){n(16==r.length,"a.length == 16"),n(16==e.length,"b.length == 16"),n(void 0==i||16==i.length,"r == undefined || r.length == 16"),n(r!=i&&e!=i,"a != r && b != r"),void 0==i&&(i=new t(16));var a=r[0],o=r[1],u=r[2],l=r[3],s=r[4],c=r[5],f=r[6],h=r[7],g=r[8],d=r[9],v=r[10],m=r[11],p=r[12],y=r[13],M=r[14],w=r[15],x=e[0],F=e[1],b=e[2],A=e[3],_=e[4],j=e[5],k=e[6],O=e[7],E=e[8],q=e[9],N=e[10],I=e[11],T=e[12],R=e[13],S=e[14],z=e[15];return i[0]=a*x+s*F+g*b+p*A,i[1]=o*x+c*F+d*b+y*A,i[2]=u*x+f*F+v*b+M*A,i[3]=l*x+h*F+m*b+w*A,i[4]=a*_+s*j+g*k+p*O,i[5]=o*_+c*j+d*k+y*O,i[6]=u*_+f*j+v*k+M*O,i[7]=l*_+h*j+m*k+w*O,i[8]=a*E+s*q+g*N+p*I,i[9]=o*E+c*q+d*N+y*I,i[10]=u*E+f*q+v*N+M*I,i[11]=l*E+h*q+m*N+w*I,i[12]=a*T+s*R+g*S+p*z,i[13]=o*T+c*R+d*S+y*z,i[14]=u*T+f*R+v*S+M*z,i[15]=l*T+h*R+m*S+w*z,i},i.mulOffset=function(t,r,e,i){n(16==t.length,"a.length == 16"),n(16==r.length,"b.length == 16");var a=t[1],o=t[2],u=t[3],l=t[4],s=t[5],c=t[6],f=t[7],h=t[8],g=t[9],d=t[10],v=t[11],m=t[12],p=t[13],y=t[14],M=t[15],w=r[0],x=r[1],F=r[2],b=r[3],A=r[4],_=r[5],j=r[6],k=r[7],O=r[8],E=r[9],q=r[10],N=r[11],I=r[12],T=r[13],R=r[14],S=r[15];return e[i+0]=a11*w+l*x+h*F+m*b,e[i+1]=a*w+s*x+g*F+p*b,e[i+2]=o*w+c*x+d*F+y*b,e[i+3]=u*w+f*x+v*F+M*b,e[i+4]=a11*A+l*_+h*j+m*k,e[i+5]=a*A+s*_+g*j+p*k,e[i+6]=o*A+c*_+d*j+y*k,e[i+7]=u*A+f*_+v*j+M*k,e[i+8]=a11*O+l*E+h*q+m*N,e[i+9]=a*O+s*E+g*q+p*N,e[i+10]=o*O+c*E+d*q+y*N,e[i+11]=u*O+f*E+v*q+M*N,e[i+12]=a11*I+l*T+h*R+m*S,e[i+13]=a*I+s*T+g*R+p*S,e[i+14]=o*I+c*T+d*R+y*S,e[i+15]=u*I+f*T+v*R+M*S,e},i.mulAffine=function(r,e,i){n(16==r.length,"a.length == 16"),n(16==e.length,"b.length == 16"),n(void 0==i||16==i.length,"r == undefined || r.length == 16"),n(r!=i&&e!=i,"a != r && b != r"),void 0==i&&(i=new t(16));var a=r[0],o=r[1],u=r[2],l=r[4],s=r[5],c=r[6],f=r[8],h=r[9],g=r[10],d=r[12],v=r[13],m=r[14],p=e[0],y=e[1],M=e[2],w=e[4],x=e[5],F=e[6],b=e[8],A=e[9],_=e[10],j=e[12],k=e[13],O=e[14];return i[0]=a*p+l*y+f*M,i[1]=o*p+s*y+h*M,i[2]=u*p+c*y+g*M,i[3]=0,i[4]=a*w+l*x+f*F,i[5]=o*w+s*x+h*F,i[6]=u*w+c*x+g*F,i[7]=0,i[8]=a*b+l*A+f*_,i[9]=o*b+s*A+h*_,i[10]=u*b+c*A+g*_,i[11]=0,i[12]=a*j+l*k+f*O+d,i[13]=o*j+s*k+h*O+v,i[14]=u*j+c*k+g*O+m,i[15]=1,i},i.mulAffine=function(r,e,i,a){n(16==r.length,"a.length == 16"),n(16==e.length,"b.length == 16"),void 0==i&&(i=new t(16));var o=r[0],u=r[1],l=r[2],s=r[4],c=r[5],f=r[6],h=r[8],g=r[9],d=r[10],v=r[12],m=r[13],p=r[14],y=e[0],M=e[1],w=e[2],x=e[4],F=e[5],b=e[6],A=e[8],_=e[9],j=e[10],k=e[12],O=e[13],E=e[14];return i[a+0]=o*y+s*M+h*w,i[a+1]=u*y+c*M+g*w,i[a+2]=l*y+f*M+d*w,i[a+3]=0,i[a+4]=o*x+s*F+h*b,i[a+5]=u*x+c*F+g*b,i[a+6]=l*x+f*F+d*b,i[a+7]=0,i[a+8]=o*A+s*_+h*j,i[a+9]=u*A+c*_+g*j,i[a+10]=l*A+f*_+d*j,i[a+11]=0,i[a+12]=o*k+s*O+h*E+v,i[a+13]=u*k+c*O+g*E+m,i[a+14]=l*k+f*O+d*E+p,i[a+15]=1,i},i.makeRotate=function(r,i,a){n(3==r.length,"angle.length == 3"),n(3==i.length,"axis.length == 3"),n(void 0==a||16==a.length,"r == undefined || r.length == 16"),void 0==a&&(a=new t(16)),i=e.normalize(i,e._temp1);var o=i[0],u=i[1],l=i[2],s=Math.cos(r),c=1-s,f=Math.sin(r);return a[0]=o*o*c+s,a[1]=u*o*c+l*f,a[2]=l*o*c-u*f,a[3]=0,a[4]=o*u*c-l*f,a[5]=u*u*c+s,a[6]=u*l*c+o*f,a[7]=0,a[8]=o*l*c+u*f,a[9]=u*l*c-o*f,a[10]=l*l*c+s,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},i.rotate=function(r,e,i,a){n(3==r.length,"angle.length == 3"),n(3==e.length,"axis.length == 3"),n(16==i.length,"m.length == 16"),n(void 0==a||16==a.length,"r == undefined || r.length == 16"),void 0==a&&(a=new t(16));var o=e[0],u=e[1],l=e[2],s=Math.sqrt(o*o+u*u+l*l),c=o,f=u,h=l;if(1!=s){var g=1/s;c*=g,f*=g,h*=g}var d=Math.cos(r),v=1-d,m=Math.sin(r),p=c*m,y=f*m,M=h*m,w=c*f*v,x=c*h*v,F=f*h*v,b=i[0],A=i[1],_=i[2],j=i[3],k=i[4],O=i[5],E=i[6],q=i[7],N=i[8],I=i[9],T=i[10],R=i[11],S=c*c*v+d,z=w+M,P=x-y,D=w-M,Q=f*f*v+d,Y=F+p,B=x+y,L=F-p,V=h*h*v+d;return a[0]=b*S+k*z+N*P,a[1]=A*S+O*z+I*P,a[2]=_*S+E*z+T*P,a[3]=j*S+q*z+R*P,a[4]=b*D+k*Q+N*Y,a[5]=A*D+O*Q+I*Y,a[6]=_*D+E*Q+T*Y,a[7]=j*D+q*Q+R*Y,a[8]=b*B+k*L+N*V,a[9]=A*B+O*L+I*V,a[10]=_*B+E*L+T*V,a[11]=j*B+q*L+R*V,a!=i&&(a[12]=i[12],a[13]=i[13],a[14]=i[14],a[15]=i[15]),a},i.makeScale3=function(r,e,i,a){return n(void 0==a||16==a.length,"r == undefined || r.length == 16"),void 0==a&&(a=new t(16)),a[0]=r,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=e,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=i,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},i.makeScale1=function(t,r){return n(void 0==r||16==r.length,"r == undefined || r.length == 16"),i.makeScale3(t,t,t,r)},i.makeScale=function(t,r){return n(3==t.length,"v.length == 3"),n(void 0==r||16==r.length,"r == undefined || r.length == 16"),i.makeScale3(t[0],t[1],t[2],r)},i.scale3=function(r,e,i,a,o){return n(16==a.length,"m.length == 16"),n(void 0==o||16==o.length,"r == undefined || r.length == 16"),o==a?(a[0]*=r,a[1]*=r,a[2]*=r,a[3]*=r,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=i,a[9]*=i,a[10]*=i,a[11]*=i,a):(void 0==o&&(o=new t(16)),o[0]=a[0]*r,o[1]=a[1]*r,o[2]=a[2]*r,o[3]=a[3]*r,o[4]=a[4]*e,o[5]=a[5]*e,o[6]=a[6]*e,o[7]=a[7]*e,o[8]=a[8]*i,o[9]=a[9]*i,o[10]=a[10]*i,o[11]=a[11]*i,o[12]=a[12],o[13]=a[13],o[14]=a[14],o[15]=a[15],o)},i.scale1=function(r,e,i){return n(16==e.length,"m.length == 16"),n(void 0==i||16==i.length,"r == undefined || r.length == 16"),i==e?(e[0]*=r,e[1]*=r,e[2]*=r,e[3]*=r,e[4]*=r,e[5]*=r,e[6]*=r,e[7]*=r,e[8]*=r,e[9]*=r,e[10]*=r,e[11]*=r,e):(void 0==i&&(i=new t(16)),i[0]=e[0]*r,i[1]=e[1]*r,i[2]=e[2]*r,i[3]=e[3]*r,i[4]=e[4]*r,i[5]=e[5]*r,i[6]=e[6]*r,i[7]=e[7]*r,i[8]=e[8]*r,i[9]=e[9]*r,i[10]=e[10]*r,i[11]=e[11]*r,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i)},i.scale=function(r,e,i){n(3==r.length,"v.length == 3"),n(16==e.length,"m.length == 16"),n(void 0==i||16==i.length,"r == undefined || r.length == 16");var a=r[0],o=r[1],u=r[2];return i==e?(e[0]*=a,e[1]*=a,e[2]*=a,e[3]*=a,e[4]*=o,e[5]*=o,e[6]*=o,e[7]*=o,e[8]*=u,e[9]*=u,e[10]*=u,e[11]*=u,e):(void 0==i&&(i=new t(16)),i[0]=e[0]*a,i[1]=e[1]*a,i[2]=e[2]*a,i[3]=e[3]*a,i[4]=e[4]*o,i[5]=e[5]*o,i[6]=e[6]*o,i[7]=e[7]*o,i[8]=e[8]*u,i[9]=e[9]*u,i[10]=e[10]*u,i[11]=e[11]*u,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i)},i.makeTranslate3=function(r,e,i,a){return n(void 0==a||16==a.length,"r == undefined || r.length == 16"),void 0==a&&(a=new t(16)),a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=r,a[13]=e,a[14]=i,a[15]=1,a},i.makeTranslate1=function(t,r){return n(void 0==r||16==r.length,"r == undefined || r.length == 16"),i.makeTranslate3(t,t,t,r)},i.makeTranslate=function(t,r){return n(3==t.length,"v.length == 3"),n(void 0==r||16==r.length,"r == undefined || r.length == 16"),i.makeTranslate3(t[0],t[1],t[2],r)},i.translate3Self=function(t,e,i,a){return n(16==a.length,"m.length == 16"),n(void 0==r||16==r.length,"r == undefined || r.length == 16"),a[12]+=a[0]*t+a[4]*e+a[8]*i,a[13]+=a[1]*t+a[5]*e+a[9]*i,a[14]+=a[2]*t+a[6]*e+a[10]*i,a[15]+=a[3]*t+a[7]*e+a[11]*i,a},i.translate3=function(r,e,i,a,o){if(n(16==a.length,"m.length == 16"),n(void 0==o||16==o.length,"r == undefined || r.length == 16"),o==a)return a[12]+=a[0]*r+a[4]*e+a[8]*i,a[13]+=a[1]*r+a[5]*e+a[9]*i,a[14]+=a[2]*r+a[6]*e+a[10]*i,a[15]+=a[3]*r+a[7]*e+a[11]*i,a;void 0==o&&(o=new t(16));var u=a[0],l=a[1],s=a[2],c=a[3],f=a[4],h=a[5],g=a[6],d=a[7],v=a[8],m=a[9],p=a[10],y=a[11];return o[0]=u,o[1]=l,o[2]=s,o[3]=c,o[4]=f,o[5]=h,o[6]=g,o[7]=d,o[8]=v,o[9]=m,o[10]=p,o[11]=y,o[12]=u*r+f*e+v*i+a[12],o[13]=l*r+h*e+m*i+a[13],o[14]=s*r+g*e+p*i+a[14],o[15]=c*r+d*e+y*i+a[15],o},i.translate1=function(t,r,e){return n(16==r.length,"m.length == 16"),n(void 0==e||16==e.length,"r == undefined || r.length == 16"),i.translate3(t,t,t,r,e)},i.translateSelf=function(t,r){n(3==t.length,"v.length == 3"),n(16==r.length,"m.length == 16");var e=t[0],i=t[1],a=t[2];return r[12]+=r[0]*e+r[4]*i+r[8]*a,r[13]+=r[1]*e+r[5]*i+r[9]*a,r[14]+=r[2]*e+r[6]*i+r[10]*a,r[15]+=r[3]*e+r[7]*i+r[11]*a,r},i.translate=function(r,e,i){n(3==r.length,"v.length == 3"),n(16==e.length,"m.length == 16"),n(void 0==i||16==i.length,"r == undefined || r.length == 16");var a=r[0],o=r[1],u=r[2];if(i==e)return e[12]+=e[0]*a+e[4]*o+e[8]*u,e[13]+=e[1]*a+e[5]*o+e[9]*u,e[14]+=e[2]*a+e[6]*o+e[10]*u,e[15]+=e[3]*a+e[7]*o+e[11]*u,e;void 0==i&&(i=new t(16));var l=e[0],s=e[1],c=e[2],f=e[3],h=e[4],g=e[5],d=e[6],v=e[7],m=e[8],p=e[9],y=e[10],M=e[11];return i[0]=l,i[1]=s,i[2]=c,i[3]=f,i[4]=h,i[5]=g,i[6]=d,i[7]=v,i[8]=m,i[9]=p,i[10]=y,i[11]=M,i[12]=l*a+h*o+m*u+e[12],i[13]=s*a+g*o+p*u+e[13],i[14]=c*a+d*o+y*u+e[14],i[15]=f*a+v*o+M*u+e[15],i},i.makeLookAt=function(r,a,o,u){n(3==r.length,"eye.length == 3"),n(3==a.length,"center.length == 3"),n(3==o.length,"up.length == 3"),n(void 0==u||16==u.length,"r == undefined || r.length == 16");var l=e.direction(r,a,e._temp1),s=e.normalize(e.cross(o,l,e._temp2),e._temp2),c=e.normalize(e.cross(l,s,e._temp3),e._temp3),f=i._temp1,h=i._temp2;return f[0]=s[0],f[1]=c[0],f[2]=l[0],f[3]=0,f[4]=s[1],f[5]=c[1],f[6]=l[1],f[7]=0,f[8]=s[2],f[9]=c[2],f[10]=l[2],f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,h[0]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=1,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=1,h[11]=0,h[12]=-r[0],h[13]=-r[1],h[14]=-r[2],h[15]=1,void 0==u&&(u=new t(16)),i.mul(f,h,u)},i.transposeSelf=function(t){n(16==t.length,"m.length == 16");var r=t[1];return t[1]=t[4],t[4]=r,r=t[2],t[2]=t[8],t[8]=r,r=t[3],t[3]=t[12],t[12]=r,r=t[6],t[6]=t[9],t[9]=r,r=t[7],t[7]=t[13],t[13]=r,r=t[11],t[11]=t[14],t[14]=r,t},i.transpose=function(r,e){if(n(16==r.length,"m.length == 16"),n(void 0==e||16==e.length,"r == undefined || r.length == 16"),r==e){var i=0;return i=r[1],r[1]=r[4],r[4]=i,i=r[2],r[2]=r[8],r[8]=i,i=r[3],r[3]=r[12],r[12]=i,i=r[6],r[6]=r[9],r[9]=i,i=r[7],r[7]=r[13],r[13]=i,i=r[11],r[11]=r[14],r[14]=i,r}return void 0==e&&(e=new t(16)),e[0]=r[0],e[1]=r[4],e[2]=r[8],e[3]=r[12],e[4]=r[1],e[5]=r[5],e[6]=r[9],e[7]=r[13],e[8]=r[2],e[9]=r[6],e[10]=r[10],e[11]=r[14],e[12]=r[3],e[13]=r[7],e[14]=r[11],e[15]=r[15],e},i.transformPoint=function(r,e,i){n(16==r.length,"m.length == 16"),n(3==e.length,"v.length == 3"),n(void 0==i||3==i.length,"r == undefined || r.length == 3"),void 0==i&&(i=new t(3));
var a=e[0],o=e[1],u=e[2];i[0]=r[0]*a+r[4]*o+r[8]*u+r[12],i[1]=r[1]*a+r[5]*o+r[9]*u+r[13],i[2]=r[2]*a+r[6]*o+r[10]*u+r[14];var l=r[3]*a+r[7]*o+r[11]*u+r[15];return 1!=l&&(i[0]/=l,i[1]/=l,i[2]/=l),i},i.transformLine=function(r,e,i){n(16==r.length,"m.length == 16"),n(3==e.length,"v.length == 3"),n(void 0==i||3==i.length,"r == undefined || r.length == 3"),void 0==i&&(i=new t(3));var a=e[0],o=e[1],u=e[2];i[0]=r[0]*a+r[4]*o+r[8]*u,i[1]=r[1]*a+r[5]*o+r[9]*u,i[2]=r[2]*a+r[6]*o+r[10]*u;var l=r[3]*a+r[7]*o+r[11]*u;return 1!=l&&(i[0]/=l,i[1]/=l,i[2]/=l),i},i.transformPointAffine=function(r,e,i){n(16==r.length,"m.length == 16"),n(3==e.length,"v.length == 3"),n(void 0==i||3==i.length,"r == undefined || r.length == 3"),void 0==i&&(i=new t(3));var a=e[0],o=e[1],u=e[2];return i[0]=r[0]*a+r[4]*o+r[8]*u+r[12],i[1]=r[1]*a+r[5]*o+r[9]*u+r[13],i[2]=r[2]*a+r[6]*o+r[10]*u+r[14],i},i.transformLineAffine=function(r,e,i){n(16==r.length,"m.length == 16"),n(3==e.length,"v.length == 3"),n(void 0==i||3==i.length,"r == undefined || r.length == 3"),void 0==i&&(i=new t(3));var a=e[0],o=e[1],u=e[2];return i[0]=r[0]*a+r[4]*o+r[8]*u,i[1]=r[1]*a+r[5]*o+r[9]*u,i[2]=r[2]*a+r[6]*o+r[10]*u,i};var a={FLOAT_ARRAY_TYPE:t,V3:e,M4x4:i};return a}),define("base",["underscore","mjs"],function(n,t){return function(r){n.without(Object.getOwnPropertyNames(Math),"round").forEach(function(n){r.register(n,Math[n])}),Object.getOwnPropertyNames(t).forEach(function(n){r.register(n,t[n])}),r.alias("M4","M4x4")}}),define("common",["underscore"],function(n){return function(t){t.register("sum",function(r){return t.assert(t.isArray(r),"can't compute sum of non-array "+r),n.reduce(t.toFloat(r),function(n,r){return t.isNumber(r)||t.throwError("can't compute sum of array with non numeric element: "+r),n+r},0)}),t.register("square",function(n){return t.assert(t.isNumber(n),"can't square non numeric element: "+n),parseFloat(n)*parseFloat(n)}),t.register("round",function(n,r){return r=r||0,t.assert(20>=r,"round: can only round to 20 decimal places"),t.assert(t.isNumber(n),"round: "+n+" is not a numeric type"),parseFloat(new Number(n+"").toFixed(parseInt(r)))}),t.register("roundArray",function(n,r){return t.throwError(t.isArray(n),"roundArray: not an array"),t.scalarIterator(n,function(n){return t.round(n,r)})})}}),define("converters",["underscore"],function(n){return function(t){t.register("toFloat",function(r){if(t.isNumber(r))return parseFloat(r);if(t.isNativeFloatArray(r))return r;if(t.isArray(r)){var e=function(n){return t.assert(t.isNumber(n),"toFloat: array has something in it that is not a number: "+n),parseFloat(n)};return t.is2DArray(r)?n.map(r,function(t){return n.map(t,e)}):n.map(r,e)}t.throwError("toFloat: can not convert to float: "+r)}),t.register("unitConversionScale",function(r,e){var i={m:1,meter:1,cm:100,mm:1e3,um:1e6,nm:1e9,inch:39.37007874015748,"in":39.37007874015748},a=n.keys(i);return t.assert(n.contains(a,e)&&n.contains(a,r),"no conversion for either "+r+" or "+e),parseFloat(i[e]/i[r])}),t.register("toDegrees",function(n){var r=function(n){return t.assert(t.isNumber(n),"toDegrees: not a number"),t.abs(n)<=1e-10?0:180/t.PI*n};return t.isNumber(n)?r(n):t.scalarIterator(n,r)}),t.register("toRadians",function(n){var r=function(n){return t.assert(t.isNumber(n),"toRadians: not a number"),t.PI/180*n};return t.isNumber(n)?r(n):t.scalarIterator(n,r)}),t.register("parseAxisAngle",function(r,e){var i,a,o=function(){t.throwError("parseAxisAngle: arguments were not something we recognized")};return t.isArray(r)?4==r.length&&void 0===e?(i=r.slice(0,3),a=r[3]):3==r.length&&void 0!==e?(i=r,a=e):o():n.isObject(r)&&void 0===e?r.hasOwnProperty("axis")&&r.hasOwnProperty("angle")?(i=r.axis,a=r.angle):o():o(),{axis:t.toFloat(i),angle:t.toFloat(a)}}),t.register("quatFromAxisAngle",function(r,e){var i=t.parseAxisAngle(r,e),a=i.axis,o=i.angle,u=t.sum(n.map(a,t.square));if(1e-10>=u)return[1,0,0,0];var l=o/2,s=Math.sin(l)/Math.sqrt(u);return[Math.cos(l),a[0]*s,a[1]*s,a[2]*s]}),t.register("quatFromMatrix",function(n){var r=t.toFloat(n),e=r[0][0]+r[1][1]+r[2][2],i=[0,0,0,0];return e>=0?(i[0]=e+1,i[1]=r[2][1]-r[1][2],i[2]=r[0][2]-r[2][0],i[3]=r[1][0]-r[0][1]):r[1][1]>r[0][0]?r[2][2]>r[1][1]?(i[3]=r[2][2]-(r[0][0]+r[1][1])+1,i[1]=r[2][0]+r[0][2],i[2]=r[1][2]+r[2][1],i[0]=r[1][0]-r[0][1]):(i[2]=r[1][1]-(r[2][2]+r[0][0])+1,i[3]=r[1][2]+r[2][1],i[1]=r[0][1]+r[1][0],i[0]=r[0][2]-r[2][0]):r[2][2]>r[0][0]?(i[3]=r[2][2]-(r[0][0]+r[1][1])+1,i[1]=r[2][0]+r[0][2],i[2]=r[1][2]+r[2][1],i[0]=r[1][0]-r[0][1]):(i[1]=r[0][0]-(r[1][1]+r[2][2])+1,i[2]=r[0][1]+r[1][0],i[3]=r[2][0]+r[0][2],i[0]=r[2][1]-r[1][2]),t.divide(i,t.magnitude(i))}),t.register("matrixFromQuat",function(n){var r=t.toFloat(n),e=t.square(t.magnitude(r));if(1e-8>=e)return m.eye(4);var i=2/e,a=i*r[1]*r[1],o=i*r[2]*r[2],u=i*r[3]*r[3],l=t.eye(4);return l[0][0]=1-o-u,l[0][1]=i*(r[1]*r[2]-r[0]*r[3]),l[0][2]=i*(r[1]*r[3]+r[0]*r[2]),l[1][0]=i*(r[1]*r[2]+r[0]*r[3]),l[1][1]=1-a-u,l[1][2]=i*(r[2]*r[3]-r[0]*r[1]),l[2][0]=i*(r[1]*r[3]-r[0]*r[2]),l[2][1]=i*(r[2]*r[3]+r[0]*r[1]),l[2][2]=1-a-o,l}),t.register("axisAngleFromQuat",function(r){var e=t.toFloat(r),i=t.sum(n.map(e.slice(1,4),t.square)),a={axis:[1,0,0],angle:0};if(0===i)return a;if(e[0]*e[0]+i<=1e-8)throw new Error("invalid quaternion "+e);var o;o=e[0]<0?[-e[0],-e[1],-e[2],-e[3]]:e,i=Math.sqrt(i);var u=1/i,l=2*Math.atan2(i,o[0]);return{axis:[o[1]*u,o[2]*u,o[3]*u],angle:l}}),t.register("axisAngleFromMatrix",function(n){return t.axisAngleFromQuat(t.quatFromMatrix(n))}),t.register("zxyFromMatrix",function(n){var r,e,i,a=t.matrix4to3(t.toFloat(n)),o=1e-10;if(Math.abs(a[2][0])<o&&Math.abs(a[2][2])<o){var u=a[2][1];r=u>0?Math.PI/2:-Math.PI/2,i=0,e=Math.atan2(u*a[1][0],a[0][0])}else{e=Math.atan2(-a[2][0],a[2][2]);var l=Math.sin(e),s=Math.cos(e),c=[[s,0,-l],[0,1,0],[l,0,s]],f=t.matrixMult(a,c);r=Math.atan2(f[2][1],f[2][2]),i=Math.atan2(f[1][0],f[0][0])}return t.toDegrees([r,e,i])}),t.register("zyxFromMatrix",function(n){var r,e,i,a=t.toFloat(n),o=1e-10;if(Math.abs(a[2][1])<o&&Math.abs(a[2][2])<o)if(e=a[2][0]<=0?Math.PI/2:-Math.PI/2,e>0){var u=Math.atan2(a[0][1],a[1][1]);r=u,i=0}else{var l=-Math.atan2(a[0][1],a[1][1]);r=l,i=0}else{r=Math.atan2(a[2][1],a[2][2]);var s=Math.sin(r),c=Math.cos(r),f=[[1,0,0],[0,c,s],[0,-s,c]],h=t.matrixMult(t.matrix4to3(a),f);e=Math.atan2(-h[2][0],h[2][2]),i=Math.atan2(-h[0][1],h[1][1])}return t.toDegrees([r,e,i])}),t.register("matrixFromZXY",function(n){var r=t.toRadians(parseFloat(n[0])),e=t.toRadians(parseFloat(n[1])),i=t.toRadians(parseFloat(n[2]));return[[-Math.sin(r)*Math.sin(e)*Math.sin(i)+Math.cos(e)*Math.cos(i),-Math.sin(i)*Math.cos(r),Math.sin(r)*Math.sin(i)*Math.cos(e)+Math.sin(e)*Math.cos(i)],[Math.sin(r)*Math.sin(e)*Math.cos(i)+Math.sin(i)*Math.cos(e),Math.cos(r)*Math.cos(i),-Math.sin(r)*Math.cos(e)*Math.cos(i)+Math.sin(e)*Math.sin(i)],[-Math.sin(e)*Math.cos(r),Math.sin(r),Math.cos(r)*Math.cos(e)]]}),t.register("matrixFromZYX",function(n){var r=t.toRadians(parseFloat(n[0])),e=t.toRadians(parseFloat(n[1])),i=t.toRadians(parseFloat(n[2]));return[[Math.cos(e)*Math.cos(i),-Math.cos(r)*Math.sin(i)+Math.cos(i)*Math.sin(r)*Math.sin(e),Math.sin(r)*Math.sin(i)+Math.cos(r)*Math.cos(i)*Math.sin(e)],[Math.cos(e)*Math.sin(i),Math.cos(r)*Math.cos(i)+Math.sin(r)*Math.sin(e)*Math.sin(i),-Math.cos(i)*Math.sin(r)+Math.cos(r)*Math.sin(e)*Math.sin(i)],[-Math.sin(e),Math.cos(e)*Math.sin(r),Math.cos(r)*Math.cos(e)]]}),t.register("zxyFromQuat",function(n){return t.zxyFromMatrix(t.matrixFromQuat(t.toFloat(n)))}),t.register("quatFromZXY",function(n){return t.quatFromMatrix(t.matrixFromZXY(t.toFloat(n)))}),t.register("zyxFromQuat",function(n){return t.zyxFromMatrix(t.matrixFromQuat(t.toFloat(n)))}),t.register("quatFromZYX",function(n){return t.quatFromMatrix(t.matrixFromZYX(t.toFloat(n)))}),t.register("matrix4to3",function(n){return[[n[0][0],n[0][1],n[0][2]],[n[1][0],n[1][1],n[1][2]],[n[2][0],n[2][1],n[2][2]]]}),t.register("composeTransformArray",function(n,t){return[[n[0][0],n[0][1],n[0][2],t[0]],[n[1][0],n[1][1],n[1][2],t[1]],[n[2][0],n[2][1],n[2][2],t[2]],[0,0,0,1]]}),t.register("decomposeTransformArray",function(n){return{rotationMatrix:[n[0].slice(0,3),n[1].slice(0,3),n[2].slice(0,3)],translation:[n[0][3],n[1][3],n[2][3]]}}),t.register("M4toTransformArray",function(n){return[[n[0],n[4],n[8],n[12]],[n[1],n[5],n[9],n[13]],[n[2],n[6],n[10],n[14]],[n[3],n[7],n[11],n[15]]]}),t.register("transformArrayToM4",function(n){return[n[0][0],n[1][0],n[2][0],n[3][0],n[0][1],n[1][1],n[2][1],n[3][1],n[0][2],n[1][2],n[2][2],n[3][2],n[0][3],n[1][3],n[2][3],n[3][3]]})}}),define("matrix",["underscore"],function(n){return function(t){t.register("divide",function(n,r){return t.scalarIterator(t.toFloat(n),function(n){return n/parseFloat(r)})}),t.register("eye",function(n,t){t=t||n;for(var r=[],e=0;t>e;e++){for(var i=[],a=0;n>a;a++)e==a?i.push(1):i.push(0);r.push(i)}return r}),t.register("magnitude",function(r){return t.isNativeFloatArray(r)?(t.assert(3===r.length,"magnitude: native float array's need to be of length three"),t.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2])):t.sqrt(t.sum(n.map(t.toFloat(r),t.square)))}),t.alias("norm","magnitude"),t.register("normalize",function(n){var r=t.magnitude(n);return t.assert(0!==r,"normalize: trying to normalize a zero array"),t.divide(n,r)}),t.register("matrixMult",function(n,r){var e=t.toFloat(n),i=t.toFloat(r);t.assert(e[0].length===e.length,"matrixMult: incompatible array sizes!");for(var a=[],o=0;o<e.length;o++){for(var u=[],l=0;l<i[o].length;l++){for(var s=0,c=0;c<e[o].length;c++)s+=e[o][c]*i[c][l];u.push(s)}a.push(u)}return a})}}),define("V3",["underscore","mjs"],function(n){return function(t){t.register("V3.objectToArray",function(r){return t.assert(n.isObject(r),"not an object"),["x","y","z"].map(function(n){return r[n]})}),t.register("V3.arrayToObject",function(r){t.assert(t.isArray(r),"not an array");var e=t.toFloat(r);return n.object(["x","y","z"],e)})}}),define("M4",["underscore","mjs"],function(n){return function(t){t.register("M4.matrixFromQuat",function(r){t.assert(4===r.length,"M4.matrixFromQuat: quatRaw.length !== 4");var e=t.toFloat(r),i=t.M4.clone(t.M4.I),a=t.sum(n.map(e,t.square));if(1e-8>=a)return i;var o=2/a,u=o*e[1]*e[1],l=o*e[2]*e[2],s=o*e[3]*e[3];return i[0]=1-l-s,i[1]=o*(e[1]*e[2]+e[0]*e[3]),i[2]=o*(e[1]*e[3]-e[0]*e[2]),i[4]=o*(e[1]*e[2]-e[0]*e[3]),i[5]=1-u-s,i[6]=o*(e[2]*e[3]+e[0]*e[1]),i[8]=o*(e[1]*e[3]+e[0]*e[2]),i[9]=o*(e[2]*e[3]-e[0]*e[1]),i[10]=1-u-l,i}),t.register("M4.quatFromMatrix",function(n){var r=t.toFloat(n),e=r[0],i=r[1],a=r[2],o=r[4],u=r[5],l=r[6],s=r[8],c=r[9],f=r[10],h=e+u+f,g=[0,0,0,0];return h>=0?(g[0]=h+1,g[1]=l-c,g[2]=s-a,g[3]=i-o):u>e?f>u?(g[3]=f-(e+u)+1,g[1]=a+s,g[2]=c+l,g[0]=i-o):(g[2]=u-(f+e)+1,g[3]=c+l,g[1]=o+i,g[0]=s-a):f>e?(g[3]=f-(e+u)+1,g[1]=a+s,g[2]=c+l,g[0]=i-o):(g[1]=e-(u+f)+1,g[2]=o+i,g[3]=a+s,g[0]=l-c),t.divide(g,t.magnitude(g))}),t.register("M4.transFromMatrix",function(n){var t=new Array(3);return t[0]=n[12],t[1]=n[13],t[2]=n[14],t}),t.register("M4.composeFromQuatTrans",function(n,r){var e=t.M4.matrixFromQuat(n),i=t.toFloat(r);return t.assert(3===i.length,"M4.composeFromQuatTrans: trans.length !== 3"),e[12]=i[0],e[13]=i[1],e[14]=i[2],e})}}),define("tween",["underscore"],function(){return function(n){n.register("linearlyInterpolate",function(n,t,r,e,i){return(t*(r-i)+e*(i-n))/(r-n)})}}),define("shrike",["underscore","./utils","./iterators","./base","./common","./converters","./matrix","./V3","./M4","./tween"],function(n,t,r,e,i,a,o,u,l,s){var c={};return t(c),r(c),e(c),i(c),a(c),o(c),u(c),l(c),s(c),void 0!==window.makeGlobal&&(window.makeGlobal(c),window.makeGlobal({math:c,shrike:c})),c});