// shrike - v0.0.0
// yet another javascript math library
//
// Copyright (c)2014 Lucas Doyle <lucas.p.doyle@gmail.com>
// Distributed under MIT license
//
// https://github.com/Stonelinks/shrike

define(["underscore","mjs"],function(a,b){"use strict";var c={};window.pass=window.pass||function(){},c.throwError=function(a){throw a=a||"undefined error",new Error("SHRIKE: "+a)};var d=!0;return c.assert=d&&(window.hasOwnProperty("DEBUG")?window.DEBUG:d)?function(a,b){a||c.throwError(b)}:window.pass,c.register=function(b,d){var e=b.split(".").reverse();if(1==e.length)c.assert(!c.hasOwnProperty(b),"shrike already has a "+b),c[b]=d;else for(var f=e[0],g=c;e.length>0;){var h=e.pop();c.assert(!(g.hasOwnProperty(h)&&!a.isObject(g[h])),"shrike already has a "+b),h===f?g[h]=d:(a.isObject(g[h])||(g[h]={}),g=g[h])}},c.alias=function(a,b){c.assert(c.hasOwnProperty(b),"shrike doesn't have a "+b+" to alias"),c.register(a,c[b])},c.register("isArray",function(b){return a.isArray(b)?!0:c.isNativeFloatArray(b)}),c.register("isNativeFloatArray",function(b){try{return a.isArray(b)!==!0&&"Array]"==Object.prototype.toString.call(b).slice(-"Array]".length)}catch(c){return!1}}),c.register("is2DArray",function(b){return c.isArray(b)?c.isNativeFloatArray(b)?!1:0===b.length?!1:a.every(a.map(b,c.isArray)):!1}),c.register("isNumber",function(a){return!isNaN(parseFloat(a))&&isFinite(a)&&!c.isArray(a)}),c.register("prettyPrint",function(b){console.log(function(){if(c.isArray(b)){if(c.is2DArray(b)){for(var d=6,e=0,f=0;f<b.length;f++)for(var g=0;g<b[f].length;g++)c.assert(!a.isString(b[f][g]),"prettyPrint: there is a string in this matrix, you should fix that"),c.round(b[f][g],d).toString().length>e&&(e=c.round(b[f][g],d).toString().length);for(var h=[],i=void 0,f=0;f<b.length;f++){for(var j=[],g=0;g<b[f].length;g++){for(var k=c.round(b[f][g],d).toString(),l=e-k.length,m="",n="",o=0;l>o;o++)o>=l/2?m+=" ":n+=" ";j.push(m+k+n)}if(h.push(j),void 0===i){for(var p=[],q="",o=0;e>o;o++)q+="-";for(var o=0;o<j.length;o++)p.push(q);i="+-"+p.join("-+-")+"-+"}}for(var r=i+"\n",f=0;f<b.length;f++){var j=h[f],s="| "+j.join(" | ")+" |";r+=s+"\n",r+=i+"\n"}return r}var r="[ "+new Array(b).join(", ")+" ]";return r}return b}())}),window.pp=c.prettyPrint,c.register("scalarIterator",function(b,d){if(d=d||pass,c.is2DArray(b))return a.map(b,function(b){return a.map(b,d)});if(c.isArray(b)){if(c.isNativeFloatArray(b)){for(var e=new c.FLOAT_ARRAY_TYPE(b.length),f=0;f<b.length;f++)e[f]=d(b[f]);return e}return a.map(b,d)}return d(b)}),a.without(Object.getOwnPropertyNames(Math),"round").forEach(function(a){c.register(a,Math[a])}),Object.getOwnPropertyNames(b).forEach(function(a){c.register(a,b[a])}),c.alias("M4","M4x4"),c.register("sum",function(b){return c.assert(c.isArray(b),"can't compute sum of non-array "+b),a.reduce(c.toFloat(b),function(a,b){return c.isNumber(b)||c.throwError("can't compute sum of array with non numeric element: "+b),a+b},0)}),c.register("square",function(a){return c.assert(c.isNumber(a),"can't square non numeric element: "+a),parseFloat(a)*parseFloat(a)}),c.register("round",function(a,b){return b=b||0,c.assert(20>=b,"round: can only round to 20 decimal places"),c.assert(c.isNumber(a),"round: "+a+" is not a numeric type"),parseFloat(new Number(a+"").toFixed(parseInt(b)))}),c.register("roundArray",function(a,b){return c.throwError(c.isArray(a),"roundArray: not an array"),c.scalarIterator(a,function(a){return c.round(a,b)})}),c.register("toFloat",function(b){if(c.isNumber(b))return parseFloat(b);if(c.isNativeFloatArray(b))return b;if(c.isArray(b)){var d=function(a){return c.assert(c.isNumber(a),"toFloat: array has something in it that is not a number: "+a),parseFloat(a)};return c.is2DArray(b)?a.map(b,function(b){return a.map(b,d)}):a.map(b,d)}c.throwError("toFloat: can not convert to float: "+b)}),c.register("unitConversionScale",function(b,d){var e={m:1,meter:1,cm:100,mm:1e3,um:1e6,nm:1e9,inch:39.37007874015748,"in":39.37007874015748},f=a.keys(e);return c.assert(a.contains(f,d)&&a.contains(f,b),"no conversion for either "+b+" or "+d),parseFloat(e[d]/e[b])}),c.register("toDegrees",function(a){var b=function(a){return c.assert(c.isNumber(a),"toDegrees: not a number"),c.abs(a)<=1e-10?0:180/c.PI*a};return c.isNumber(a)?b(a):c.scalarIterator(a,b)}),c.register("toRadians",function(a){var b=function(a){return c.assert(c.isNumber(a),"toRadians: not a number"),c.PI/180*a};return c.isNumber(a)?b(a):c.scalarIterator(a,b)}),c.register("parseAxisAngle",function(b,d){var e,f,g=function(){c.throwError("parseAxisAngle: arguments were not something we recognized")};return c.isArray(b)?4==b.length&&void 0===d?(e=b.slice(0,3),f=b[3]):3==b.length&&void 0!==d?(e=b,f=d):g():a.isObject(b)&&void 0===d?b.hasOwnProperty("axis")&&b.hasOwnProperty("angle")?(e=b.axis,f=b.angle):g():g(),{axis:c.toFloat(e),angle:c.toFloat(f)}}),c.register("quatFromAxisAngle",function(b,d){var e=c.parseAxisAngle(b,d),f=e.axis,g=e.angle,h=c.sum(a.map(f,c.square));if(1e-10>=h)return[1,0,0,0];var i=g/2,j=Math.sin(i)/Math.sqrt(h);return[Math.cos(i),f[0]*j,f[1]*j,f[2]*j]}),c.register("quatFromMatrix",function(a){var b=c.toFloat(a),d=b[0][0]+b[1][1]+b[2][2],e=[0,0,0,0];return d>=0?(e[0]=d+1,e[1]=b[2][1]-b[1][2],e[2]=b[0][2]-b[2][0],e[3]=b[1][0]-b[0][1]):b[1][1]>b[0][0]?b[2][2]>b[1][1]?(e[3]=b[2][2]-(b[0][0]+b[1][1])+1,e[1]=b[2][0]+b[0][2],e[2]=b[1][2]+b[2][1],e[0]=b[1][0]-b[0][1]):(e[2]=b[1][1]-(b[2][2]+b[0][0])+1,e[3]=b[1][2]+b[2][1],e[1]=b[0][1]+b[1][0],e[0]=b[0][2]-b[2][0]):b[2][2]>b[0][0]?(e[3]=b[2][2]-(b[0][0]+b[1][1])+1,e[1]=b[2][0]+b[0][2],e[2]=b[1][2]+b[2][1],e[0]=b[1][0]-b[0][1]):(e[1]=b[0][0]-(b[1][1]+b[2][2])+1,e[2]=b[0][1]+b[1][0],e[3]=b[2][0]+b[0][2],e[0]=b[2][1]-b[1][2]),c.divide(e,c.magnitude(e))}),c.register("matrixFromQuat",function(a){var b=c.toFloat(a),d=c.square(c.magnitude(b));if(1e-8>=d)return m.eye(4);var e=2/d,f=e*b[1]*b[1],g=e*b[2]*b[2],h=e*b[3]*b[3],i=c.eye(4);return i[0][0]=1-g-h,i[0][1]=e*(b[1]*b[2]-b[0]*b[3]),i[0][2]=e*(b[1]*b[3]+b[0]*b[2]),i[1][0]=e*(b[1]*b[2]+b[0]*b[3]),i[1][1]=1-f-h,i[1][2]=e*(b[2]*b[3]-b[0]*b[1]),i[2][0]=e*(b[1]*b[3]-b[0]*b[2]),i[2][1]=e*(b[2]*b[3]+b[0]*b[1]),i[2][2]=1-f-g,i}),c.register("axisAngleFromQuat",function(b){var d=c.toFloat(b),e=c.sum(a.map(d.slice(1,4),c.square)),f={axis:[1,0,0],angle:0};if(0===e)return f;if(d[0]*d[0]+e<=1e-8)throw new Error("invalid quaternion "+d);var g;g=d[0]<0?[-d[0],-d[1],-d[2],-d[3]]:d,e=Math.sqrt(e);var h=1/e,i=2*Math.atan2(e,g[0]);return{axis:[g[1]*h,g[2]*h,g[3]*h],angle:i}}),c.register("axisAngleFromMatrix",function(a){return c.axisAngleFromQuat(c.quatFromMatrix(a))}),c.register("zxyFromMatrix",function(a){var b,d,e,f=c.matrix4to3(c.toFloat(a)),g=1e-10;if(Math.abs(f[2][0])<g&&Math.abs(f[2][2])<g){var h=f[2][1];b=h>0?Math.PI/2:-Math.PI/2,e=0,d=Math.atan2(h*f[1][0],f[0][0])}else{d=Math.atan2(-f[2][0],f[2][2]);var i=Math.sin(d),j=Math.cos(d),k=[[j,0,-i],[0,1,0],[i,0,j]],l=c.matrixMult(f,k);b=Math.atan2(l[2][1],l[2][2]),e=Math.atan2(l[1][0],l[0][0])}return c.toDegrees([b,d,e])}),c.register("zyxFromMatrix",function(a){var b,d,e,f=c.toFloat(a),g=1e-10;if(Math.abs(f[2][1])<g&&Math.abs(f[2][2])<g)if(d=f[2][0]<=0?Math.PI/2:-Math.PI/2,d>0){var h=Math.atan2(f[0][1],f[1][1]);b=h,e=0}else{var i=-Math.atan2(f[0][1],f[1][1]);b=i,e=0}else{b=Math.atan2(f[2][1],f[2][2]);var j=Math.sin(b),k=Math.cos(b),l=[[1,0,0],[0,k,j],[0,-j,k]],m=c.matrixMult(c.matrix4to3(f),l);d=Math.atan2(-m[2][0],m[2][2]),e=Math.atan2(-m[0][1],m[1][1])}return c.toDegrees([b,d,e])}),c.register("matrixFromZXY",function(a){var b=c.toRadians(parseFloat(a[0])),d=c.toRadians(parseFloat(a[1])),e=c.toRadians(parseFloat(a[2]));return[[-Math.sin(b)*Math.sin(d)*Math.sin(e)+Math.cos(d)*Math.cos(e),-Math.sin(e)*Math.cos(b),Math.sin(b)*Math.sin(e)*Math.cos(d)+Math.sin(d)*Math.cos(e)],[Math.sin(b)*Math.sin(d)*Math.cos(e)+Math.sin(e)*Math.cos(d),Math.cos(b)*Math.cos(e),-Math.sin(b)*Math.cos(d)*Math.cos(e)+Math.sin(d)*Math.sin(e)],[-Math.sin(d)*Math.cos(b),Math.sin(b),Math.cos(b)*Math.cos(d)]]}),c.register("matrixFromZYX",function(a){var b=c.toRadians(parseFloat(a[0])),d=c.toRadians(parseFloat(a[1])),e=c.toRadians(parseFloat(a[2]));return[[Math.cos(d)*Math.cos(e),-Math.cos(b)*Math.sin(e)+Math.cos(e)*Math.sin(b)*Math.sin(d),Math.sin(b)*Math.sin(e)+Math.cos(b)*Math.cos(e)*Math.sin(d)],[Math.cos(d)*Math.sin(e),Math.cos(b)*Math.cos(e)+Math.sin(b)*Math.sin(d)*Math.sin(e),-Math.cos(e)*Math.sin(b)+Math.cos(b)*Math.sin(d)*Math.sin(e)],[-Math.sin(d),Math.cos(d)*Math.sin(b),Math.cos(b)*Math.cos(d)]]}),c.register("zxyFromQuat",function(a){return c.zxyFromMatrix(c.matrixFromQuat(c.toFloat(a)))}),c.register("quatFromZXY",function(a){return c.quatFromMatrix(c.matrixFromZXY(c.toFloat(a)))}),c.register("zyxFromQuat",function(a){return c.zyxFromMatrix(c.matrixFromQuat(c.toFloat(a)))}),c.register("quatFromZYX",function(a){return c.quatFromMatrix(c.matrixFromZYX(c.toFloat(a)))}),c.register("matrix4to3",function(a){return[[a[0][0],a[0][1],a[0][2]],[a[1][0],a[1][1],a[1][2]],[a[2][0],a[2][1],a[2][2]]]}),c.register("composeTransformArray",function(a,b){return[[a[0][0],a[0][1],a[0][2],b[0]],[a[1][0],a[1][1],a[1][2],b[1]],[a[2][0],a[2][1],a[2][2],b[2]],[0,0,0,1]]}),c.register("decomposeTransformArray",function(a){return{rotationMatrix:[a[0].slice(0,3),a[1].slice(0,3),a[2].slice(0,3)],translation:[a[0][3],a[1][3],a[2][3]]}}),c.register("M4toTransformArray",function(a){return[[a[0],a[4],a[8],a[12]],[a[1],a[5],a[9],a[13]],[a[2],a[6],a[10],a[14]],[a[3],a[7],a[11],a[15]]]}),c.register("transformArrayToM4",function(a){return[a[0][0],a[1][0],a[2][0],a[3][0],a[0][1],a[1][1],a[2][1],a[3][1],a[0][2],a[1][2],a[2][2],a[3][2],a[0][3],a[1][3],a[2][3],a[3][3]]}),c.register("divide",function(a,b){return c.scalarIterator(c.toFloat(a),function(a){return a/parseFloat(b)})}),c.register("eye",function(a,b){b=b||a;for(var c=[],d=0;b>d;d++){for(var e=[],f=0;a>f;f++)e.push(d==f?1:0);c.push(e)}return c}),c.register("magnitude",function(b){return c.isNativeFloatArray(b)?(c.assert(3===b.length,"magnitude: native float array's need to be of length three"),c.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])):c.sqrt(c.sum(a.map(c.toFloat(b),c.square)))}),c.alias("norm","magnitude"),c.register("normalize",function(a){var b=c.magnitude(a);return c.assert(0!==b,"normalize: trying to normalize a zero array"),c.divide(a,b)}),c.register("matrixMult",function(a,b){var d=c.toFloat(a),e=c.toFloat(b);c.assert(d[0].length===d.length,"matrixMult: incompatible array sizes!");for(var f=[],g=0;g<d.length;g++){for(var h=[],i=0;i<e[g].length;i++){for(var j=0,k=0;k<d[g].length;k++)j+=d[g][k]*e[k][i];h.push(j)}f.push(h)}return f}),c.register("V3.objectToArray",function(b){return c.assert(a.isObject(b),"not an object"),["x","y","z"].map(function(a){return b[a]})}),c.register("V3.arrayToObject",function(b){c.assert(c.isArray(b),"not an array");var d=c.toFloat(b);return a.object(["x","y","z"],d)}),c.register("M4.matrixFromQuat",function(b){c.assert(4===b.length,"M4.matrixFromQuat: quatRaw.length !== 4");var d=c.toFloat(b),e=c.M4.clone(c.M4.I),f=c.sum(a.map(d,c.square));if(1e-8>=f)return e;var g=2/f,h=g*d[1]*d[1],i=g*d[2]*d[2],j=g*d[3]*d[3];return e[0]=1-i-j,e[1]=g*(d[1]*d[2]+d[0]*d[3]),e[2]=g*(d[1]*d[3]-d[0]*d[2]),e[4]=g*(d[1]*d[2]-d[0]*d[3]),e[5]=1-h-j,e[6]=g*(d[2]*d[3]+d[0]*d[1]),e[8]=g*(d[1]*d[3]+d[0]*d[2]),e[9]=g*(d[2]*d[3]-d[0]*d[1]),e[10]=1-h-i,e}),c.register("M4.quatFromMatrix",function(a){var b=c.toFloat(a),d=b[0],e=b[1],f=b[2],g=b[4],h=b[5],i=b[6],j=b[8],k=b[9],l=b[10],m=d+h+l,n=[0,0,0,0];return m>=0?(n[0]=m+1,n[1]=i-k,n[2]=j-f,n[3]=e-g):h>d?l>h?(n[3]=l-(d+h)+1,n[1]=f+j,n[2]=k+i,n[0]=e-g):(n[2]=h-(l+d)+1,n[3]=k+i,n[1]=g+e,n[0]=j-f):l>d?(n[3]=l-(d+h)+1,n[1]=f+j,n[2]=k+i,n[0]=e-g):(n[1]=d-(h+l)+1,n[2]=g+e,n[3]=f+j,n[0]=i-k),c.divide(n,c.magnitude(n))}),c.register("M4.transFromMatrix",function(a){var b=new Array(3);return b[0]=a[12],b[1]=a[13],b[2]=a[14],b}),c.register("M4.composeFromQuatTrans",function(a,b){var d=c.M4.matrixFromQuat(a),e=c.toFloat(b);return c.assert(3===e.length,"M4.composeFromQuatTrans: trans.length !== 3"),d[12]=e[0],d[13]=e[1],d[14]=e[2],d}),c.register("linearlyInterpolate",function(a,b,c,d,e){return(b*(c-e)+d*(e-a))/(c-a)}),void 0!==window.makeGlobal&&(window.makeGlobal(c),window.makeGlobal({math:c,shrike:c})),c});