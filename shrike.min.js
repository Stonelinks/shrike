(function(){var n=this,t=n._,r={},e=Array.prototype,a=Object.prototype,i=Function.prototype,o=e.push,u=e.slice,l=e.concat,s=a.toString,c=a.hasOwnProperty,f=e.forEach,h=e.map,g=e.reduce,d=e.reduceRight,v=e.filter,m=e.every,p=e.some,y=e.indexOf,w=e.lastIndexOf,M=Array.isArray,x=Object.keys,F=i.bind,b=function(n){return n instanceof b?n:this instanceof b?(this._wrapped=n,void 0):new b(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=b),exports._=b):n._=b,b.VERSION="1.6.0";var A=b.each=b.forEach=function(n,t,e){if(null==n)return n;if(f&&n.forEach===f)n.forEach(t,e);else if(n.length===+n.length){for(var a=0,i=n.length;i>a;a++)if(t.call(e,n[a],a,n)===r)return}else for(var o=b.keys(n),a=0,i=o.length;i>a;a++)if(t.call(e,n[o[a]],o[a],n)===r)return;return n};b.map=b.collect=function(n,t,r){var e=[];return null==n?e:h&&n.map===h?n.map(t,r):(A(n,function(n,a,i){e.push(t.call(r,n,a,i))}),e)};var _="Reduce of empty array with no initial value";b.reduce=b.foldl=b.inject=function(n,t,r,e){var a=arguments.length>2;if(null==n&&(n=[]),g&&n.reduce===g)return e&&(t=b.bind(t,e)),a?n.reduce(t,r):n.reduce(t);if(A(n,function(n,i,o){a?r=t.call(e,r,n,i,o):(r=n,a=!0)}),!a)throw new TypeError(_);return r},b.reduceRight=b.foldr=function(n,t,r,e){var a=arguments.length>2;if(null==n&&(n=[]),d&&n.reduceRight===d)return e&&(t=b.bind(t,e)),a?n.reduceRight(t,r):n.reduceRight(t);var i=n.length;if(i!==+i){var o=b.keys(n);i=o.length}if(A(n,function(u,l,s){l=o?o[--i]:--i,a?r=t.call(e,r,n[l],l,s):(r=n[l],a=!0)}),!a)throw new TypeError(_);return r},b.find=b.detect=function(n,t,r){var e;return k(n,function(n,a,i){return t.call(r,n,a,i)?(e=n,!0):void 0}),e},b.filter=b.select=function(n,t,r){var e=[];return null==n?e:v&&n.filter===v?n.filter(t,r):(A(n,function(n,a,i){t.call(r,n,a,i)&&e.push(n)}),e)},b.reject=function(n,t,r){return b.filter(n,function(n,e,a){return!t.call(r,n,e,a)},r)},b.every=b.all=function(n,t,e){t||(t=b.identity);var a=!0;return null==n?a:m&&n.every===m?n.every(t,e):(A(n,function(n,i,o){return(a=a&&t.call(e,n,i,o))?void 0:r}),!!a)};var k=b.some=b.any=function(n,t,e){t||(t=b.identity);var a=!1;return null==n?a:p&&n.some===p?n.some(t,e):(A(n,function(n,i,o){return a||(a=t.call(e,n,i,o))?r:void 0}),!!a)};b.contains=b.include=function(n,t){return null==n?!1:y&&n.indexOf===y?-1!=n.indexOf(t):k(n,function(n){return n===t})},b.invoke=function(n,t){var r=u.call(arguments,2),e=b.isFunction(t);return b.map(n,function(n){return(e?t:n[t]).apply(n,r)})},b.pluck=function(n,t){return b.map(n,b.property(t))},b.where=function(n,t){return b.filter(n,b.matches(t))},b.findWhere=function(n,t){return b.find(n,b.matches(t))},b.max=function(n,t,r){if(!t&&b.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.max.apply(Math,n);var e=-1/0,a=-1/0;return A(n,function(n,i,o){var u=t?t.call(r,n,i,o):n;u>a&&(e=n,a=u)}),e},b.min=function(n,t,r){if(!t&&b.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.min.apply(Math,n);var e=1/0,a=1/0;return A(n,function(n,i,o){var u=t?t.call(r,n,i,o):n;a>u&&(e=n,a=u)}),e},b.shuffle=function(n){var t,r=0,e=[];return A(n,function(n){t=b.random(r++),e[r-1]=e[t],e[t]=n}),e},b.sample=function(n,t,r){return null==t||r?(n.length!==+n.length&&(n=b.values(n)),n[b.random(n.length-1)]):b.shuffle(n).slice(0,Math.max(0,t))};var E=function(n){return null==n?b.identity:b.isFunction(n)?n:b.property(n)};b.sortBy=function(n,t,r){return t=E(t),b.pluck(b.map(n,function(n,e,a){return{value:n,index:e,criteria:t.call(r,n,e,a)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||void 0===r)return 1;if(e>r||void 0===e)return-1}return n.index-t.index}),"value")};var j=function(n){return function(t,r,e){var a={};return r=E(r),A(t,function(i,o){var u=r.call(e,i,o,t);n(a,u,i)}),a}};b.groupBy=j(function(n,t,r){b.has(n,t)?n[t].push(r):n[t]=[r]}),b.indexBy=j(function(n,t,r){n[t]=r}),b.countBy=j(function(n,t){b.has(n,t)?n[t]++:n[t]=1}),b.sortedIndex=function(n,t,r,e){r=E(r);for(var a=r.call(e,t),i=0,o=n.length;o>i;){var u=i+o>>>1;r.call(e,n[u])<a?i=u+1:o=u}return i},b.toArray=function(n){return n?b.isArray(n)?u.call(n):n.length===+n.length?b.map(n,b.identity):b.values(n):[]},b.size=function(n){return null==n?0:n.length===+n.length?n.length:b.keys(n).length},b.first=b.head=b.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:0>t?[]:u.call(n,0,t)},b.initial=function(n,t,r){return u.call(n,0,n.length-(null==t||r?1:t))},b.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:u.call(n,Math.max(n.length-t,0))},b.rest=b.tail=b.drop=function(n,t,r){return u.call(n,null==t||r?1:t)},b.compact=function(n){return b.filter(n,b.identity)};var O=function(n,t,r){return t&&b.every(n,b.isArray)?l.apply(r,n):(A(n,function(n){b.isArray(n)||b.isArguments(n)?t?o.apply(r,n):O(n,t,r):r.push(n)}),r)};b.flatten=function(n,t){return O(n,t,[])},b.without=function(n){return b.difference(n,u.call(arguments,1))},b.partition=function(n,t){var r=[],e=[];return A(n,function(n){(t(n)?r:e).push(n)}),[r,e]},b.uniq=b.unique=function(n,t,r,e){b.isFunction(t)&&(e=r,r=t,t=!1);var a=r?b.map(n,r,e):n,i=[],o=[];return A(a,function(r,e){(t?e&&o[o.length-1]===r:b.contains(o,r))||(o.push(r),i.push(n[e]))}),i},b.union=function(){return b.uniq(b.flatten(arguments,!0))},b.intersection=function(n){var t=u.call(arguments,1);return b.filter(b.uniq(n),function(n){return b.every(t,function(t){return b.contains(t,n)})})},b.difference=function(n){var t=l.apply(e,u.call(arguments,1));return b.filter(n,function(n){return!b.contains(t,n)})},b.zip=function(){for(var n=b.max(b.pluck(arguments,"length").concat(0)),t=new Array(n),r=0;n>r;r++)t[r]=b.pluck(arguments,""+r);return t},b.object=function(n,t){if(null==n)return{};for(var r={},e=0,a=n.length;a>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},b.indexOf=function(n,t,r){if(null==n)return-1;var e=0,a=n.length;if(r){if("number"!=typeof r)return e=b.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,a+r):r}if(y&&n.indexOf===y)return n.indexOf(t,r);for(;a>e;e++)if(n[e]===t)return e;return-1},b.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=null!=r;if(w&&n.lastIndexOf===w)return e?n.lastIndexOf(t,r):n.lastIndexOf(t);for(var a=e?r:n.length;a--;)if(n[a]===t)return a;return-1},b.range=function(n,t,r){arguments.length<=1&&(t=n||0,n=0),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n)/r),0),a=0,i=new Array(e);e>a;)i[a++]=n,n+=r;return i};var I=function(){};b.bind=function(n,t){var r,e;if(F&&n.bind===F)return F.apply(n,u.call(arguments,1));if(!b.isFunction(n))throw new TypeError;return r=u.call(arguments,2),e=function(){if(!(this instanceof e))return n.apply(t,r.concat(u.call(arguments)));I.prototype=n.prototype;var a=new I;I.prototype=null;var i=n.apply(a,r.concat(u.call(arguments)));return Object(i)===i?i:a}},b.partial=function(n){var t=u.call(arguments,1);return function(){for(var r=0,e=t.slice(),a=0,i=e.length;i>a;a++)e[a]===b&&(e[a]=arguments[r++]);for(;r<arguments.length;)e.push(arguments[r++]);return n.apply(this,e)}},b.bindAll=function(n){var t=u.call(arguments,1);if(0===t.length)throw new Error("bindAll must be passed function names");return A(t,function(t){n[t]=b.bind(n[t],n)}),n},b.memoize=function(n,t){var r={};return t||(t=b.identity),function(){var e=t.apply(this,arguments);return b.has(r,e)?r[e]:r[e]=n.apply(this,arguments)}},b.delay=function(n,t){var r=u.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},b.defer=function(n){return b.delay.apply(b,[n,1].concat(u.call(arguments,1)))},b.throttle=function(n,t,r){var e,a,i,o=null,u=0;r||(r={});var l=function(){u=r.leading===!1?0:b.now(),o=null,i=n.apply(e,a),e=a=null};return function(){var s=b.now();u||r.leading!==!1||(u=s);var c=t-(s-u);return e=this,a=arguments,0>=c?(clearTimeout(o),o=null,u=s,i=n.apply(e,a),e=a=null):o||r.trailing===!1||(o=setTimeout(l,c)),i}},b.debounce=function(n,t,r){var e,a,i,o,u,l=function(){var s=b.now()-o;t>s?e=setTimeout(l,t-s):(e=null,r||(u=n.apply(i,a),i=a=null))};return function(){i=this,a=arguments,o=b.now();var s=r&&!e;return e||(e=setTimeout(l,t)),s&&(u=n.apply(i,a),i=a=null),u}},b.once=function(n){var t,r=!1;return function(){return r?t:(r=!0,t=n.apply(this,arguments),n=null,t)}},b.wrap=function(n,t){return b.partial(t,n)},b.compose=function(){var n=arguments;return function(){for(var t=arguments,r=n.length-1;r>=0;r--)t=[n[r].apply(this,t)];return t[0]}},b.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},b.keys=function(n){if(!b.isObject(n))return[];if(x)return x(n);var t=[];for(var r in n)b.has(n,r)&&t.push(r);return t},b.values=function(n){for(var t=b.keys(n),r=t.length,e=new Array(r),a=0;r>a;a++)e[a]=n[t[a]];return e},b.pairs=function(n){for(var t=b.keys(n),r=t.length,e=new Array(r),a=0;r>a;a++)e[a]=[t[a],n[t[a]]];return e},b.invert=function(n){for(var t={},r=b.keys(n),e=0,a=r.length;a>e;e++)t[n[r[e]]]=r[e];return t},b.functions=b.methods=function(n){var t=[];for(var r in n)b.isFunction(n[r])&&t.push(r);return t.sort()},b.extend=function(n){return A(u.call(arguments,1),function(t){if(t)for(var r in t)n[r]=t[r]}),n},b.pick=function(n){var t={},r=l.apply(e,u.call(arguments,1));return A(r,function(r){r in n&&(t[r]=n[r])}),t},b.omit=function(n){var t={},r=l.apply(e,u.call(arguments,1));for(var a in n)b.contains(r,a)||(t[a]=n[a]);return t},b.defaults=function(n){return A(u.call(arguments,1),function(t){if(t)for(var r in t)void 0===n[r]&&(n[r]=t[r])}),n},b.clone=function(n){return b.isObject(n)?b.isArray(n)?n.slice():b.extend({},n):n},b.tap=function(n,t){return t(n),n};var q=function(n,t,r,e){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;n instanceof b&&(n=n._wrapped),t instanceof b&&(t=t._wrapped);var a=s.call(n);if(a!=s.call(t))return!1;switch(a){case"[object String]":return n==String(t);case"[object Number]":return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case"[object Date]":case"[object Boolean]":return+n==+t;case"[object RegExp]":return n.source==t.source&&n.global==t.global&&n.multiline==t.multiline&&n.ignoreCase==t.ignoreCase}if("object"!=typeof n||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]==n)return e[i]==t;var o=n.constructor,u=t.constructor;if(o!==u&&!(b.isFunction(o)&&o instanceof o&&b.isFunction(u)&&u instanceof u)&&"constructor"in n&&"constructor"in t)return!1;r.push(n),e.push(t);var l=0,c=!0;if("[object Array]"==a){if(l=n.length,c=l==t.length)for(;l--&&(c=q(n[l],t[l],r,e)););}else{for(var f in n)if(b.has(n,f)&&(l++,!(c=b.has(t,f)&&q(n[f],t[f],r,e))))break;if(c){for(f in t)if(b.has(t,f)&&!l--)break;c=!l}}return r.pop(),e.pop(),c};b.isEqual=function(n,t){return q(n,t,[],[])},b.isEmpty=function(n){if(null==n)return!0;if(b.isArray(n)||b.isString(n))return 0===n.length;for(var t in n)if(b.has(n,t))return!1;return!0},b.isElement=function(n){return!(!n||1!==n.nodeType)},b.isArray=M||function(n){return"[object Array]"==s.call(n)},b.isObject=function(n){return n===Object(n)},A(["Arguments","Function","String","Number","Date","RegExp"],function(n){b["is"+n]=function(t){return s.call(t)=="[object "+n+"]"}}),b.isArguments(arguments)||(b.isArguments=function(n){return!(!n||!b.has(n,"callee"))}),"function"!=typeof/./&&(b.isFunction=function(n){return"function"==typeof n}),b.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},b.isNaN=function(n){return b.isNumber(n)&&n!=+n},b.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==s.call(n)},b.isNull=function(n){return null===n},b.isUndefined=function(n){return void 0===n},b.has=function(n,t){return c.call(n,t)},b.noConflict=function(){return n._=t,this},b.identity=function(n){return n},b.constant=function(n){return function(){return n}},b.property=function(n){return function(t){return t[n]}},b.matches=function(n){return function(t){if(t===n)return!0;for(var r in n)if(n[r]!==t[r])return!1;return!0}},b.times=function(n,t,r){for(var e=Array(Math.max(0,n)),a=0;n>a;a++)e[a]=t.call(r,a);return e},b.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},b.now=Date.now||function(){return(new Date).getTime()};var z={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};z.unescape=b.invert(z.escape);var N={escape:new RegExp("["+b.keys(z.escape).join("")+"]","g"),unescape:new RegExp("("+b.keys(z.unescape).join("|")+")","g")};b.each(["escape","unescape"],function(n){b[n]=function(t){return null==t?"":(""+t).replace(N[n],function(t){return z[n][t]})}}),b.result=function(n,t){if(null==n)return void 0;var r=n[t];return b.isFunction(r)?r.call(n):r},b.mixin=function(n){A(b.functions(n),function(t){var r=b[t]=n[t];b.prototype[t]=function(){var n=[this._wrapped];return o.apply(n,arguments),D.call(this,r.apply(b,n))}})};var S=0;b.uniqueId=function(n){var t=++S+"";return n?n+t:t},b.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var R=/(.)^/,T={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},P=/\\|'|\r|\n|\t|\u2028|\u2029/g;b.template=function(n,t,r){var e;r=b.defaults({},r,b.templateSettings);var a=new RegExp([(r.escape||R).source,(r.interpolate||R).source,(r.evaluate||R).source].join("|")+"|$","g"),i=0,o="__p+='";n.replace(a,function(t,r,e,a,u){return o+=n.slice(i,u).replace(P,function(n){return"\\"+T[n]}),r&&(o+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),e&&(o+="'+\n((__t=("+e+"))==null?'':__t)+\n'"),a&&(o+="';\n"+a+"\n__p+='"),i=u+t.length,t}),o+="';\n",r.variable||(o="with(obj||{}){\n"+o+"}\n"),o="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+o+"return __p;\n";try{e=new Function(r.variable||"obj","_",o)}catch(u){throw u.source=o,u}if(t)return e(t,b);var l=function(n){return e.call(this,n,b)};return l.source="function("+(r.variable||"obj")+"){\n"+o+"}",l},b.chain=function(n){return b(n).chain()};var D=function(n){return this._chain?b(n).chain():n};b.mixin(b),A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=e[n];b.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=n&&"splice"!=n||0!==r.length||delete r[0],D.call(this,r)}}),A(["concat","join","slice"],function(n){var t=e[n];b.prototype[n]=function(){return D.call(this,t.apply(this._wrapped,arguments))}}),b.extend(b.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return b})}).call(this),define("utils",["underscore"],function(n){return window.pass=window.pass||function(){},function(t){t.throwError=function(n){throw n=n||"undefined error",new Error("SHRIKE: "+n)},t.register=function(r,e){var a=r.split(".").reverse();if(1==a.length)t.hasOwnProperty(r)?t.throwError("shrike already has a "+r):t[r]=e;else for(var i=a[0],o=t;a.length>0;){var u=a.pop();o.hasOwnProperty(u)&&!n.isObject(o[u])&&t.throwError("shrike already has a "+r),u===i?o[u]=e:(n.isObject(o[u])||(o[u]={}),o=o[u])}},t.alias=function(n,r){t.hasOwnProperty(r)||t.throwError("shrike doesn't have a "+r+" to alias"),t.register(n,t[r])},t.register("isArray",function(r){return n.isArray(r)?!0:t.isNativeFloatArray(r)}),t.register("isNativeFloatArray",function(t){try{return n.isArray(t)!==!0&&"Array]"==Object.prototype.toString.call(t).slice(-"Array]".length)}catch(r){return!1}}),t.register("is2DArray",function(r){return t.isArray(r)?t.isNativeFloatArray(r)?!1:0===r.length?!1:n.some(r.map(t.isArray)):!1}),t.register("isNumber",function(n){return!isNaN(parseFloat(n))&&isFinite(n)&&!t.isArray(n)}),t.register("prettyPrint",function(r){console.log(function(){if(n.isArray(r)){if(n.isArray(r[0])){for(var e=6,a=0,i=0;i<r.length;i++)for(var o=0;o<r[i].length;o++){if("string"==typeof r[i][o])throw new Error("WARNING: there is a string in this matrix, you should fix that");t.round(r[i][o],e).toString().length>a&&(a=t.round(r[i][o],e).toString().length)}for(var u=[],l=void 0,i=0;i<r.length;i++){for(var s=[],o=0;o<r[i].length;o++){for(var c=t.round(r[i][o],e).toString(),f=a-c.length,h="",g="",d=0;f>d;d++)d>=f/2?h+=" ":g+=" ";s.push(h+c+g)}if(u.push(s),void 0===l){for(var v=[],m="",d=0;a>d;d++)m+="-";for(var d=0;d<s.length;d++)v.push(m);l="+-"+v.join("-+-")+"-+"}}for(var p=l+"\n",i=0;i<r.length;i++){var s=u[i],y="| "+s.join(" | ")+" |";p+=y+"\n",p+=l+"\n"}return p}var p="[ "+r.join(", ")+" ]";return p}return r}())}),window.pp=t.prettyPrint}}),define("iterators",["underscore"],function(){return function(n){n.register("elementWiseIterator",function(t,r,e){e=e||pass,n.isArray(t)&&n.isArray(r)||(console.warn("elementWiseIterator: one of these is not an array: %o and %o",t,r),n.throwError()),t.length!==r.length&&n.throwError("elementWiseIterator: trying to do an element-wise operation on unequal sized arrays");var a=!1;n.is2DArray(t)&&(n.is2DArray(r)?a=!0:(console.warn("elementWiseIterator: one of these is a 2d array and the other is not: %o and %o",t,r),n.throwError()));for(var i=[],o=0;o<t.length;o++)if(a){t[o].length!==r[o].length&&n.throwError("elementWiseIterator: unequal row lengths while iterating through 2d array");for(var u=[],l=0;l<t[o].length;l++)u.push(e(t[o][l],r[o][l]));i.push(u)}else i.push(e(t[o],r[o]));return i}),n.register("scalarIterator",function(t,r){return r=r||pass,n.is2DArray(t)?t.map(function(n){return n.map(r)}):n.isArray(t)?t.map(r):r(t)})}}),define("mjs",[],function(){function n(n,t){if(!n)throw"Assertion failed: "+t}function n(){}const t=Float32Array;var e={};e._temp1=new t(3),e._temp2=new t(3),e._temp3=new t(3),t==Array?(e.x=[1,0,0],e.y=[0,1,0],e.z=[0,0,1],e.$=function(n,t,r){return[n,t,r]},e.clone=function(t){return n(3==t.length,"a.length == 3"),[t[0],t[1],t[2]]}):(e.x=new t([1,0,0]),e.y=new t([0,1,0]),e.z=new t([0,0,1]),e.$=function(n,r,e){return new t([n,r,e])},e.clone=function(r){return n(3==r.length,"a.length == 3"),new t(r)}),e.u=e.x,e.v=e.y,e.add=function(r,e,a){return n(3==r.length,"a.length == 3"),n(3==e.length,"b.length == 3"),n(void 0==a||3==a.length,"r == undefined || r.length == 3"),void 0==a&&(a=new t(3)),a[0]=r[0]+e[0],a[1]=r[1]+e[1],a[2]=r[2]+e[2],a},e.sub=function(r,e,a){return n(3==r.length,"a.length == 3"),n(3==e.length,"b.length == 3"),n(void 0==a||3==a.length,"r == undefined || r.length == 3"),void 0==a&&(a=new t(3)),a[0]=r[0]-e[0],a[1]=r[1]-e[1],a[2]=r[2]-e[2],a},e.neg=function(r,e){return n(3==r.length,"a.length == 3"),n(void 0==e||3==e.length,"r == undefined || r.length == 3"),void 0==e&&(e=new t(3)),e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e},e.direction=function(r,a,i){return n(3==r.length,"a.length == 3"),n(3==a.length,"b.length == 3"),n(void 0==i||3==i.length,"r == undefined || r.length == 3"),void 0==i&&(i=new t(3)),e.normalize(e.sub(r,a,i),i)},e.length=function(t){return n(3==t.length,"a.length == 3"),Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},e.lengthSquared=function(t){return n(3==t.length,"a.length == 3"),t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},e.normalize=function(r,a){n(3==r.length,"a.length == 3"),n(void 0==a||3==a.length,"r == undefined || r.length == 3"),void 0==a&&(a=new t(3));var i=1/e.length(r);return a[0]=r[0]*i,a[1]=r[1]*i,a[2]=r[2]*i,a},e.scale=function(r,e,a){return n(3==r.length,"a.length == 3"),n(void 0==a||3==a.length,"r == undefined || r.length == 3"),void 0==a&&(a=new t(3)),a[0]=r[0]*e,a[1]=r[1]*e,a[2]=r[2]*e,a},e.dot=function(t,r){return n(3==t.length,"a.length == 3"),n(3==r.length,"b.length == 3"),t[0]*r[0]+t[1]*r[1]+t[2]*r[2]},e.cross=function(r,e,a){return n(3==r.length,"a.length == 3"),n(3==e.length,"b.length == 3"),n(void 0==a||3==a.length,"r == undefined || r.length == 3"),void 0==a&&(a=new t(3)),a[0]=r[1]*e[2]-r[2]*e[1],a[1]=r[2]*e[0]-r[0]*e[2],a[2]=r[0]*e[1]-r[1]*e[0],a},e.mul4x4=function(r,a,i){n(16==r.length,"m.length == 16"),n(3==a.length,"v.length == 3"),n(void 0==i||3==i.length,"r == undefined || r.length == 3");var o,u=e._temp1;return void 0==i&&(i=new t(3)),u[0]=r[3],u[1]=r[7],u[2]=r[11],o=e.dot(a,u)+r[15],u[0]=r[0],u[1]=r[4],u[2]=r[8],i[0]=(e.dot(a,u)+r[12])/o,u[0]=r[1],u[1]=r[5],u[2]=r[9],i[1]=(e.dot(a,u)+r[13])/o,u[0]=r[2],u[1]=r[6],u[2]=r[10],i[2]=(e.dot(a,u)+r[14])/o,i};var a={};a._temp1=new t(16),a._temp2=new t(16),t==Array?(a.I=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],a.$=function(n,t,r,e,a,i,o,u,l,s,c,f,h,g,d,v){return[n,t,r,e,a,i,o,u,l,s,c,f,h,g,d,v]},a.clone=function(t){return n(16==t.length,"m.length == 16"),new[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]}):(a.I=new t([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),a.$=function(n,r,e,a,i,o,u,l,s,c,f,h,g,d,v,m){return new t([n,r,e,a,i,o,u,l,s,c,f,h,g,d,v,m])},a.clone=function(r){return n(16==r.length,"m.length == 16"),new t(r)}),a.identity=a.I,a.topLeft3x3=function(r,e){return n(16==r.length,"m.length == 16"),n(void 0==e||9==e.length,"r == undefined || r.length == 9"),void 0==e&&(e=new t(9)),e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[4],e[4]=r[5],e[5]=r[6],e[6]=r[8],e[7]=r[9],e[8]=r[10],e},a.inverseOrthonormal=function(r,i){n(16==r.length,"m.length == 16"),n(void 0==i||16==i.length,"r == undefined || r.length == 16"),n(r!=i,"m != r"),void 0==i&&(i=new t(16)),a.transpose(r,i);var o=[r[12],r[13],r[14]];return i[3]=i[7]=i[11]=0,i[12]=-e.dot([i[0],i[4],i[8]],o),i[13]=-e.dot([i[1],i[5],i[9]],o),i[14]=-e.dot([i[2],i[6],i[10]],o),i},a.inverseTo3x3=function(r,e){n(16==r.length,"m.length == 16"),n(void 0==e||9==e.length,"r == undefined || r.length == 9"),void 0==e&&(e=new t(9));var a=r[10]*r[5]-r[6]*r[9],i=-r[10]*r[1]+r[2]*r[9],o=r[6]*r[1]-r[2]*r[5],u=-r[10]*r[4]+r[6]*r[8],l=r[10]*r[0]-r[2]*r[8],s=-r[6]*r[0]+r[2]*r[4],c=r[9]*r[4]-r[5]*r[8],f=-r[9]*r[0]+r[1]*r[8],h=r[5]*r[0]-r[1]*r[4],g=r[0]*a+r[1]*u+r[2]*c;if(0==g)throw"matrix not invertible";var d=1/g;return e[0]=d*a,e[1]=d*i,e[2]=d*o,e[3]=d*u,e[4]=d*l,e[5]=d*s,e[6]=d*c,e[7]=d*f,e[8]=d*h,e},a.makeFrustum=function(r,e,a,i,o,u,l){n(void 0==l||16==l.length,"r == undefined || r.length == 16"),void 0==l&&(l=new t(16));return l[0]=2*o/(e-r),l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=2*o/(i-a),l[6]=0,l[7]=0,l[8]=(e+r)/(e-r),l[9]=(i+a)/(i-a),l[10]=-(u+o)/(u-o),l[11]=-1,l[12]=0,l[13]=0,l[14]=-2*u*o/(u-o),l[15]=0,l},a.makePerspective=function(t,r,e,i,o){n(void 0==o||16==o.length,"r == undefined || r.length == 16");var u=e*Math.tan(t*Math.PI/360),l=-u,s=l*r,c=u*r;return a.makeFrustum(s,c,l,u,e,i,o)},a.makeOrtho=function(r,e,a,i,o,u,l){n(void 0==l||16==l.length,"r == undefined || r.length == 16"),void 0==l&&(l=new t(16));return l[0]=2/(e-r),l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=2/(i-a),l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=-2/(u-o),l[11]=0,l[12]=-(e+r)/(e-r),l[13]=-(i+a)/(i-a),l[14]=-(u+o)/(u-o),l[15]=1,l},a.makeOrtho2D=function(t,r,e,i,o){return n(void 0==o||16==o.length,"r == undefined || r.length == 16"),a.makeOrtho(t,r,e,i,-1,1,o)},a.mul=function(r,e,a){n(16==r.length,"a.length == 16"),n(16==e.length,"b.length == 16"),n(void 0==a||16==a.length,"r == undefined || r.length == 16"),n(r!=a&&e!=a,"a != r && b != r"),void 0==a&&(a=new t(16));var i=r[0],o=r[1],u=r[2],l=r[3],s=r[4],c=r[5],f=r[6],h=r[7],g=r[8],d=r[9],v=r[10],m=r[11],p=r[12],y=r[13],w=r[14],M=r[15],x=e[0],F=e[1],b=e[2],A=e[3],_=e[4],k=e[5],E=e[6],j=e[7],O=e[8],I=e[9],q=e[10],z=e[11],N=e[12],S=e[13],R=e[14],T=e[15];return a[0]=i*x+s*F+g*b+p*A,a[1]=o*x+c*F+d*b+y*A,a[2]=u*x+f*F+v*b+w*A,a[3]=l*x+h*F+m*b+M*A,a[4]=i*_+s*k+g*E+p*j,a[5]=o*_+c*k+d*E+y*j,a[6]=u*_+f*k+v*E+w*j,a[7]=l*_+h*k+m*E+M*j,a[8]=i*O+s*I+g*q+p*z,a[9]=o*O+c*I+d*q+y*z,a[10]=u*O+f*I+v*q+w*z,a[11]=l*O+h*I+m*q+M*z,a[12]=i*N+s*S+g*R+p*T,a[13]=o*N+c*S+d*R+y*T,a[14]=u*N+f*S+v*R+w*T,a[15]=l*N+h*S+m*R+M*T,a},a.mulOffset=function(t,r,e,a){n(16==t.length,"a.length == 16"),n(16==r.length,"b.length == 16");var i=t[1],o=t[2],u=t[3],l=t[4],s=t[5],c=t[6],f=t[7],h=t[8],g=t[9],d=t[10],v=t[11],m=t[12],p=t[13],y=t[14],w=t[15],M=r[0],x=r[1],F=r[2],b=r[3],A=r[4],_=r[5],k=r[6],E=r[7],j=r[8],O=r[9],I=r[10],q=r[11],z=r[12],N=r[13],S=r[14],R=r[15];return e[a+0]=a11*M+l*x+h*F+m*b,e[a+1]=i*M+s*x+g*F+p*b,e[a+2]=o*M+c*x+d*F+y*b,e[a+3]=u*M+f*x+v*F+w*b,e[a+4]=a11*A+l*_+h*k+m*E,e[a+5]=i*A+s*_+g*k+p*E,e[a+6]=o*A+c*_+d*k+y*E,e[a+7]=u*A+f*_+v*k+w*E,e[a+8]=a11*j+l*O+h*I+m*q,e[a+9]=i*j+s*O+g*I+p*q,e[a+10]=o*j+c*O+d*I+y*q,e[a+11]=u*j+f*O+v*I+w*q,e[a+12]=a11*z+l*N+h*S+m*R,e[a+13]=i*z+s*N+g*S+p*R,e[a+14]=o*z+c*N+d*S+y*R,e[a+15]=u*z+f*N+v*S+w*R,e},a.mulAffine=function(r,e,a){n(16==r.length,"a.length == 16"),n(16==e.length,"b.length == 16"),n(void 0==a||16==a.length,"r == undefined || r.length == 16"),n(r!=a&&e!=a,"a != r && b != r"),void 0==a&&(a=new t(16));var i=r[0],o=r[1],u=r[2],l=r[4],s=r[5],c=r[6],f=r[8],h=r[9],g=r[10],d=r[12],v=r[13],m=r[14],p=e[0],y=e[1],w=e[2],M=e[4],x=e[5],F=e[6],b=e[8],A=e[9],_=e[10],k=e[12],E=e[13],j=e[14];return a[0]=i*p+l*y+f*w,a[1]=o*p+s*y+h*w,a[2]=u*p+c*y+g*w,a[3]=0,a[4]=i*M+l*x+f*F,a[5]=o*M+s*x+h*F,a[6]=u*M+c*x+g*F,a[7]=0,a[8]=i*b+l*A+f*_,a[9]=o*b+s*A+h*_,a[10]=u*b+c*A+g*_,a[11]=0,a[12]=i*k+l*E+f*j+d,a[13]=o*k+s*E+h*j+v,a[14]=u*k+c*E+g*j+m,a[15]=1,a},a.mulAffine=function(r,e,a,i){n(16==r.length,"a.length == 16"),n(16==e.length,"b.length == 16"),void 0==a&&(a=new t(16));var o=r[0],u=r[1],l=r[2],s=r[4],c=r[5],f=r[6],h=r[8],g=r[9],d=r[10],v=r[12],m=r[13],p=r[14],y=e[0],w=e[1],M=e[2],x=e[4],F=e[5],b=e[6],A=e[8],_=e[9],k=e[10],E=e[12],j=e[13],O=e[14];return a[i+0]=o*y+s*w+h*M,a[i+1]=u*y+c*w+g*M,a[i+2]=l*y+f*w+d*M,a[i+3]=0,a[i+4]=o*x+s*F+h*b,a[i+5]=u*x+c*F+g*b,a[i+6]=l*x+f*F+d*b,a[i+7]=0,a[i+8]=o*A+s*_+h*k,a[i+9]=u*A+c*_+g*k,a[i+10]=l*A+f*_+d*k,a[i+11]=0,a[i+12]=o*E+s*j+h*O+v,a[i+13]=u*E+c*j+g*O+m,a[i+14]=l*E+f*j+d*O+p,a[i+15]=1,a},a.makeRotate=function(r,a,i){n(3==r.length,"angle.length == 3"),n(3==a.length,"axis.length == 3"),n(void 0==i||16==i.length,"r == undefined || r.length == 16"),void 0==i&&(i=new t(16)),a=e.normalize(a,e._temp1);var o=a[0],u=a[1],l=a[2],s=Math.cos(r),c=1-s,f=Math.sin(r);return i[0]=o*o*c+s,i[1]=u*o*c+l*f,i[2]=l*o*c-u*f,i[3]=0,i[4]=o*u*c-l*f,i[5]=u*u*c+s,i[6]=u*l*c+o*f,i[7]=0,i[8]=o*l*c+u*f,i[9]=u*l*c-o*f,i[10]=l*l*c+s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},a.rotate=function(r,e,a,i){n(3==r.length,"angle.length == 3"),n(3==e.length,"axis.length == 3"),n(16==a.length,"m.length == 16"),n(void 0==i||16==i.length,"r == undefined || r.length == 16"),void 0==i&&(i=new t(16));var o=e[0],u=e[1],l=e[2],s=Math.sqrt(o*o+u*u+l*l),c=o,f=u,h=l;if(1!=s){var g=1/s;c*=g,f*=g,h*=g}var d=Math.cos(r),v=1-d,m=Math.sin(r),p=c*m,y=f*m,w=h*m,M=c*f*v,x=c*h*v,F=f*h*v,b=a[0],A=a[1],_=a[2],k=a[3],E=a[4],j=a[5],O=a[6],I=a[7],q=a[8],z=a[9],N=a[10],S=a[11],R=c*c*v+d,T=M+w,P=x-y,D=M-w,Q=f*f*v+d,W=F+p,Y=x+y,B=F-p,C=h*h*v+d;return i[0]=b*R+E*T+q*P,i[1]=A*R+j*T+z*P,i[2]=_*R+O*T+N*P,i[3]=k*R+I*T+S*P,i[4]=b*D+E*Q+q*W,i[5]=A*D+j*Q+z*W,i[6]=_*D+O*Q+N*W,i[7]=k*D+I*Q+S*W,i[8]=b*Y+E*B+q*C,i[9]=A*Y+j*B+z*C,i[10]=_*Y+O*B+N*C,i[11]=k*Y+I*B+S*C,i!=a&&(i[12]=a[12],i[13]=a[13],i[14]=a[14],i[15]=a[15]),i},a.makeScale3=function(r,e,a,i){return n(void 0==i||16==i.length,"r == undefined || r.length == 16"),void 0==i&&(i=new t(16)),i[0]=r,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=e,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=a,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},a.makeScale1=function(t,r){return n(void 0==r||16==r.length,"r == undefined || r.length == 16"),a.makeScale3(t,t,t,r)},a.makeScale=function(t,r){return n(3==t.length,"v.length == 3"),n(void 0==r||16==r.length,"r == undefined || r.length == 16"),a.makeScale3(t[0],t[1],t[2],r)},a.scale3=function(r,e,a,i,o){return n(16==i.length,"m.length == 16"),n(void 0==o||16==o.length,"r == undefined || r.length == 16"),o==i?(i[0]*=r,i[1]*=r,i[2]*=r,i[3]*=r,i[4]*=e,i[5]*=e,i[6]*=e,i[7]*=e,i[8]*=a,i[9]*=a,i[10]*=a,i[11]*=a,i):(void 0==o&&(o=new t(16)),o[0]=i[0]*r,o[1]=i[1]*r,o[2]=i[2]*r,o[3]=i[3]*r,o[4]=i[4]*e,o[5]=i[5]*e,o[6]=i[6]*e,o[7]=i[7]*e,o[8]=i[8]*a,o[9]=i[9]*a,o[10]=i[10]*a,o[11]=i[11]*a,o[12]=i[12],o[13]=i[13],o[14]=i[14],o[15]=i[15],o)},a.scale1=function(r,e,a){return n(16==e.length,"m.length == 16"),n(void 0==a||16==a.length,"r == undefined || r.length == 16"),a==e?(e[0]*=r,e[1]*=r,e[2]*=r,e[3]*=r,e[4]*=r,e[5]*=r,e[6]*=r,e[7]*=r,e[8]*=r,e[9]*=r,e[10]*=r,e[11]*=r,e):(void 0==a&&(a=new t(16)),a[0]=e[0]*r,a[1]=e[1]*r,a[2]=e[2]*r,a[3]=e[3]*r,a[4]=e[4]*r,a[5]=e[5]*r,a[6]=e[6]*r,a[7]=e[7]*r,a[8]=e[8]*r,a[9]=e[9]*r,a[10]=e[10]*r,a[11]=e[11]*r,a[12]=e[12],a[13]=e[13],a[14]=e[14],a[15]=e[15],a)},a.scale=function(r,e,a){n(3==r.length,"v.length == 3"),n(16==e.length,"m.length == 16"),n(void 0==a||16==a.length,"r == undefined || r.length == 16");var i=r[0],o=r[1],u=r[2];return a==e?(e[0]*=i,e[1]*=i,e[2]*=i,e[3]*=i,e[4]*=o,e[5]*=o,e[6]*=o,e[7]*=o,e[8]*=u,e[9]*=u,e[10]*=u,e[11]*=u,e):(void 0==a&&(a=new t(16)),a[0]=e[0]*i,a[1]=e[1]*i,a[2]=e[2]*i,a[3]=e[3]*i,a[4]=e[4]*o,a[5]=e[5]*o,a[6]=e[6]*o,a[7]=e[7]*o,a[8]=e[8]*u,a[9]=e[9]*u,a[10]=e[10]*u,a[11]=e[11]*u,a[12]=e[12],a[13]=e[13],a[14]=e[14],a[15]=e[15],a)},a.makeTranslate3=function(r,e,a,i){return n(void 0==i||16==i.length,"r == undefined || r.length == 16"),void 0==i&&(i=new t(16)),i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=r,i[13]=e,i[14]=a,i[15]=1,i},a.makeTranslate1=function(t,r){return n(void 0==r||16==r.length,"r == undefined || r.length == 16"),a.makeTranslate3(t,t,t,r)},a.makeTranslate=function(t,r){return n(3==t.length,"v.length == 3"),n(void 0==r||16==r.length,"r == undefined || r.length == 16"),a.makeTranslate3(t[0],t[1],t[2],r)},a.translate3Self=function(t,e,a,i){return n(16==i.length,"m.length == 16"),n(void 0==r||16==r.length,"r == undefined || r.length == 16"),i[12]+=i[0]*t+i[4]*e+i[8]*a,i[13]+=i[1]*t+i[5]*e+i[9]*a,i[14]+=i[2]*t+i[6]*e+i[10]*a,i[15]+=i[3]*t+i[7]*e+i[11]*a,i},a.translate3=function(r,e,a,i,o){if(n(16==i.length,"m.length == 16"),n(void 0==o||16==o.length,"r == undefined || r.length == 16"),o==i)return i[12]+=i[0]*r+i[4]*e+i[8]*a,i[13]+=i[1]*r+i[5]*e+i[9]*a,i[14]+=i[2]*r+i[6]*e+i[10]*a,i[15]+=i[3]*r+i[7]*e+i[11]*a,i;void 0==o&&(o=new t(16));var u=i[0],l=i[1],s=i[2],c=i[3],f=i[4],h=i[5],g=i[6],d=i[7],v=i[8],m=i[9],p=i[10],y=i[11];return o[0]=u,o[1]=l,o[2]=s,o[3]=c,o[4]=f,o[5]=h,o[6]=g,o[7]=d,o[8]=v,o[9]=m,o[10]=p,o[11]=y,o[12]=u*r+f*e+v*a+i[12],o[13]=l*r+h*e+m*a+i[13],o[14]=s*r+g*e+p*a+i[14],o[15]=c*r+d*e+y*a+i[15],o},a.translate1=function(t,r,e){return n(16==r.length,"m.length == 16"),n(void 0==e||16==e.length,"r == undefined || r.length == 16"),a.translate3(t,t,t,r,e)},a.translateSelf=function(t,r){n(3==t.length,"v.length == 3"),n(16==r.length,"m.length == 16");var e=t[0],a=t[1],i=t[2];return r[12]+=r[0]*e+r[4]*a+r[8]*i,r[13]+=r[1]*e+r[5]*a+r[9]*i,r[14]+=r[2]*e+r[6]*a+r[10]*i,r[15]+=r[3]*e+r[7]*a+r[11]*i,r},a.translate=function(r,e,a){n(3==r.length,"v.length == 3"),n(16==e.length,"m.length == 16"),n(void 0==a||16==a.length,"r == undefined || r.length == 16");var i=r[0],o=r[1],u=r[2];if(a==e)return e[12]+=e[0]*i+e[4]*o+e[8]*u,e[13]+=e[1]*i+e[5]*o+e[9]*u,e[14]+=e[2]*i+e[6]*o+e[10]*u,e[15]+=e[3]*i+e[7]*o+e[11]*u,e;void 0==a&&(a=new t(16));var l=e[0],s=e[1],c=e[2],f=e[3],h=e[4],g=e[5],d=e[6],v=e[7],m=e[8],p=e[9],y=e[10],w=e[11];return a[0]=l,a[1]=s,a[2]=c,a[3]=f,a[4]=h,a[5]=g,a[6]=d,a[7]=v,a[8]=m,a[9]=p,a[10]=y,a[11]=w,a[12]=l*i+h*o+m*u+e[12],a[13]=s*i+g*o+p*u+e[13],a[14]=c*i+d*o+y*u+e[14],a[15]=f*i+v*o+w*u+e[15],a},a.makeLookAt=function(r,i,o,u){n(3==r.length,"eye.length == 3"),n(3==i.length,"center.length == 3"),n(3==o.length,"up.length == 3"),n(void 0==u||16==u.length,"r == undefined || r.length == 16");var l=e.direction(r,i,e._temp1),s=e.normalize(e.cross(o,l,e._temp2),e._temp2),c=e.normalize(e.cross(l,s,e._temp3),e._temp3),f=a._temp1,h=a._temp2;return f[0]=s[0],f[1]=c[0],f[2]=l[0],f[3]=0,f[4]=s[1],f[5]=c[1],f[6]=l[1],f[7]=0,f[8]=s[2],f[9]=c[2],f[10]=l[2],f[11]=0,f[12]=0,f[13]=0,f[14]=0,f[15]=1,h[0]=1,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=1,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=1,h[11]=0,h[12]=-r[0],h[13]=-r[1],h[14]=-r[2],h[15]=1,void 0==u&&(u=new t(16)),a.mul(f,h,u)},a.transposeSelf=function(t){n(16==t.length,"m.length == 16");var r=t[1];return t[1]=t[4],t[4]=r,r=t[2],t[2]=t[8],t[8]=r,r=t[3],t[3]=t[12],t[12]=r,r=t[6],t[6]=t[9],t[9]=r,r=t[7],t[7]=t[13],t[13]=r,r=t[11],t[11]=t[14],t[14]=r,t},a.transpose=function(r,e){if(n(16==r.length,"m.length == 16"),n(void 0==e||16==e.length,"r == undefined || r.length == 16"),r==e){var a=0;
return a=r[1],r[1]=r[4],r[4]=a,a=r[2],r[2]=r[8],r[8]=a,a=r[3],r[3]=r[12],r[12]=a,a=r[6],r[6]=r[9],r[9]=a,a=r[7],r[7]=r[13],r[13]=a,a=r[11],r[11]=r[14],r[14]=a,r}return void 0==e&&(e=new t(16)),e[0]=r[0],e[1]=r[4],e[2]=r[8],e[3]=r[12],e[4]=r[1],e[5]=r[5],e[6]=r[9],e[7]=r[13],e[8]=r[2],e[9]=r[6],e[10]=r[10],e[11]=r[14],e[12]=r[3],e[13]=r[7],e[14]=r[11],e[15]=r[15],e},a.transformPoint=function(r,e,a){n(16==r.length,"m.length == 16"),n(3==e.length,"v.length == 3"),n(void 0==a||3==a.length,"r == undefined || r.length == 3"),void 0==a&&(a=new t(3));var i=e[0],o=e[1],u=e[2];a[0]=r[0]*i+r[4]*o+r[8]*u+r[12],a[1]=r[1]*i+r[5]*o+r[9]*u+r[13],a[2]=r[2]*i+r[6]*o+r[10]*u+r[14];var l=r[3]*i+r[7]*o+r[11]*u+r[15];return 1!=l&&(a[0]/=l,a[1]/=l,a[2]/=l),a},a.transformLine=function(r,e,a){n(16==r.length,"m.length == 16"),n(3==e.length,"v.length == 3"),n(void 0==a||3==a.length,"r == undefined || r.length == 3"),void 0==a&&(a=new t(3));var i=e[0],o=e[1],u=e[2];a[0]=r[0]*i+r[4]*o+r[8]*u,a[1]=r[1]*i+r[5]*o+r[9]*u,a[2]=r[2]*i+r[6]*o+r[10]*u;var l=r[3]*i+r[7]*o+r[11]*u;return 1!=l&&(a[0]/=l,a[1]/=l,a[2]/=l),a},a.transformPointAffine=function(r,e,a){n(16==r.length,"m.length == 16"),n(3==e.length,"v.length == 3"),n(void 0==a||3==a.length,"r == undefined || r.length == 3"),void 0==a&&(a=new t(3));var i=e[0],o=e[1],u=e[2];return a[0]=r[0]*i+r[4]*o+r[8]*u+r[12],a[1]=r[1]*i+r[5]*o+r[9]*u+r[13],a[2]=r[2]*i+r[6]*o+r[10]*u+r[14],a},a.transformLineAffine=function(r,e,a){n(16==r.length,"m.length == 16"),n(3==e.length,"v.length == 3"),n(void 0==a||3==a.length,"r == undefined || r.length == 3"),void 0==a&&(a=new t(3));var i=e[0],o=e[1],u=e[2];return a[0]=r[0]*i+r[4]*o+r[8]*u,a[1]=r[1]*i+r[5]*o+r[9]*u,a[2]=r[2]*i+r[6]*o+r[10]*u,a};var i={FLOAT_ARRAY_TYPE:t,V3:e,M4x4:a};return i}),define("base",["underscore","mjs"],function(n,t){return function(r){n.without(Object.getOwnPropertyNames(Math),"round").forEach(function(n){r.register(n,Math[n])}),Object.getOwnPropertyNames(t).forEach(function(n){r.register(n,t[n])}),r.alias("M4","M4x4")}}),define("common",["underscore"],function(n){return function(t){t.register("sum",function(r){return t.isArray(r)?n.reduce(t.toFloat(r),function(n,r){return t.isNumber(r)||t.throwError("can't compute sum of array with non numeric element: "+r),n+r},0):(t.throwError("can't compute sum of non-array "+r),void 0)}),t.register("square",function(n){return t.isNumber(n)||t.throwError("can't square non numeric element: "+n),parseFloat(n)*parseFloat(n)}),t.register("round",function(n,r){return r=r||0,r>=20&&t.throwError("round: can only round to 20 decimal places"),t.isNumber(n)?parseFloat(new Number(n+"").toFixed(parseInt(r))):(t.throwError("round: "+n+" is not a numeric type"),void 0)}),t.register("roundArray",function(n,r){return t.isArray(n)?t.scalarIterator(n,function(n){return t.round(n,r)}):(t.throwError("roundArray: not an array"),void 0)})}}),define("converters",["underscore"],function(n){return function(t){t.register("unitConversionScale",function(t,r){var e={m:1,meter:1,cm:100,mm:1e3,um:1e6,nm:1e9,inch:39.37007874015748},a=n.keys(e);if(n.contains(a,r)&&n.contains(a,t))return parseFloat(e[r]/e[t]);throw new Error("no conversion for either "+t+" or "+r)}),t.register("toDegrees",function(n){return t.scalarIterator(n,function(n){return Math.abs(n)<=1e-10?0:180/Math.PI*n})}),t.register("toRadians",function(n){return t.scalarIterator(n,function(n){return Math.PI/180*n})}),t.register("toFloat",function(n){if(t.isNumber(n))return parseFloat(n);if(t.isNativeFloatArray(n))return n;if(t.isArray(n)){var r=function(n){return t.isNumber(n)?parseFloat(n):(t.throwError("toFloat: array has something in it that is not a number: "+n),void 0)};return t.is2DArray(n)?n.map(function(n){return n.map(r)}):n.map(r)}t.throwError("toFloat: can not convert to float: "+n)}),t.register("parseAxisAngle",function(r,e){var a,i,o=function(){throw new Error("parse axis and angle input was not something we recognized")};return t.isArray(r)?4==r.length&&void 0===e?(a=r.slice(0,3),i=r[3]):3==r.length&&void 0!==e?(a=r,i=e):o():n.isObject(r)&&void 0===e?r.hasOwnProperty("axis")&&r.hasOwnProperty("angle")?(a=r.axis,i=r.angle):o():o(),{axis:t.toFloat(a),angle:t.toFloat(i)}}),t.register("quatFromAxisAngle",function(n,r){var e=t.parseAxisAngle(n,r),a=e.axis,i=e.angle,o=t.sum(a.map(t.square));if(1e-10>=o)return[1,0,0,0];var u=i/2,l=Math.sin(u)/Math.sqrt(o);return[Math.cos(u),a[0]*l,a[1]*l,a[2]*l]}),t.register("quatFromMatrix",function(n){var r=t.toFloat(n),e=r[0][0]+r[1][1]+r[2][2],a=[0,0,0,0];return e>=0?(a[0]=e+1,a[1]=r[2][1]-r[1][2],a[2]=r[0][2]-r[2][0],a[3]=r[1][0]-r[0][1]):r[1][1]>r[0][0]?r[2][2]>r[1][1]?(a[3]=r[2][2]-(r[0][0]+r[1][1])+1,a[1]=r[2][0]+r[0][2],a[2]=r[1][2]+r[2][1],a[0]=r[1][0]-r[0][1]):(a[2]=r[1][1]-(r[2][2]+r[0][0])+1,a[3]=r[1][2]+r[2][1],a[1]=r[0][1]+r[1][0],a[0]=r[0][2]-r[2][0]):r[2][2]>r[0][0]?(a[3]=r[2][2]-(r[0][0]+r[1][1])+1,a[1]=r[2][0]+r[0][2],a[2]=r[1][2]+r[2][1],a[0]=r[1][0]-r[0][1]):(a[1]=r[0][0]-(r[1][1]+r[2][2])+1,a[2]=r[0][1]+r[1][0],a[3]=r[2][0]+r[0][2],a[0]=r[2][1]-r[1][2]),t.divide(a,t.magnitude(a))}),t.register("matrixFromQuat",function(n){var r=t.toFloat(n),e=t.square(t.magnitude(r));if(1e-8>=e)return m.eye(4);var a=2/e,i=a*r[1]*r[1],o=a*r[2]*r[2],u=a*r[3]*r[3],l=t.eye(4);return l[0][0]=1-o-u,l[0][1]=a*(r[1]*r[2]-r[0]*r[3]),l[0][2]=a*(r[1]*r[3]+r[0]*r[2]),l[1][0]=a*(r[1]*r[2]+r[0]*r[3]),l[1][1]=1-i-u,l[1][2]=a*(r[2]*r[3]-r[0]*r[1]),l[2][0]=a*(r[1]*r[3]-r[0]*r[2]),l[2][1]=a*(r[2]*r[3]+r[0]*r[1]),l[2][2]=1-i-o,l}),t.register("rot",function(n,r){var e=t.parseAxisAngle(n,r),a=e.axis,i=e.angle,o=function(n){return[[0,-n[2],n[1]],[n[2],0,-n[0]],[-n[1],n[0],0]]};a=t.normalize(a);var u=t.eye(3);return u=t.add(u,t.scalarMult(o(a),Math.sin(i))),u=t.add(u,t.matrixMult(t.scalarMult(o(a),1-Math.cos(i)),o(a))),t.matrix4(u)}),t.alias("matrixFromAxisAngle","rot"),t.register("axisAngleFromQuat",function(n){var r=t.toFloat(n),e=t.sum(r.slice(1,4).map(t.square)),a={axis:[1,0,0],angle:0};if(0===e)return a;if(r[0]*r[0]+e<=1e-8)throw new Error("invalid quaternion "+r);var i;i=r[0]<0?[-r[0],-r[1],-r[2],-r[3]]:r,e=Math.sqrt(e);var o=1/e,u=2*Math.atan2(e,i[0]);return{axis:[i[1]*o,i[2]*o,i[3]*o],angle:u}}),t.register("axisAngleFromMatrix",function(n){return t.axisAngleFromQuat(t.quatFromMatrix(n))}),t.register("zxyFromMatrix",function(n){var r,e,a,i=t.matrix4to3(t.toFloat(n)),o=1e-10;if(Math.abs(i[2][0])<o&&Math.abs(i[2][2])<o){var u=i[2][1];r=u>0?Math.PI/2:-Math.PI/2,a=0,e=Math.atan2(u*i[1][0],i[0][0])}else{e=Math.atan2(-i[2][0],i[2][2]);var l=Math.sin(e),s=Math.cos(e),c=[[s,0,-l],[0,1,0],[l,0,s]],f=t.matrixMult(i,c);r=Math.atan2(f[2][1],f[2][2]),a=Math.atan2(f[1][0],f[0][0])}return t.toDegrees([r,e,a])}),t.register("zyxFromMatrix",function(n){var r,e,a,i=t.toFloat(n),o=1e-10;if(Math.abs(i[2][1])<o&&Math.abs(i[2][2])<o)if(e=i[2][0]<=0?Math.PI/2:-Math.PI/2,e>0){var u=Math.atan2(i[0][1],i[1][1]);r=u,a=0}else{var l=-Math.atan2(i[0][1],i[1][1]);r=l,a=0}else{r=Math.atan2(i[2][1],i[2][2]);var s=Math.sin(r),c=Math.cos(r),f=[[1,0,0],[0,c,s],[0,-s,c]],h=t.matrixMult(t.matrix4to3(i),f);e=Math.atan2(-h[2][0],h[2][2]),a=Math.atan2(-h[0][1],h[1][1])}return t.toDegrees([r,e,a])}),t.register("matrixFromZXY",function(n){var r=t.toRadians(parseFloat(n[0])),e=t.toRadians(parseFloat(n[1])),a=t.toRadians(parseFloat(n[2]));return[[-Math.sin(r)*Math.sin(e)*Math.sin(a)+Math.cos(e)*Math.cos(a),-Math.sin(a)*Math.cos(r),Math.sin(r)*Math.sin(a)*Math.cos(e)+Math.sin(e)*Math.cos(a)],[Math.sin(r)*Math.sin(e)*Math.cos(a)+Math.sin(a)*Math.cos(e),Math.cos(r)*Math.cos(a),-Math.sin(r)*Math.cos(e)*Math.cos(a)+Math.sin(e)*Math.sin(a)],[-Math.sin(e)*Math.cos(r),Math.sin(r),Math.cos(r)*Math.cos(e)]]}),t.register("matrixFromZYX",function(n){var r=t.toRadians(parseFloat(n[0])),e=t.toRadians(parseFloat(n[1])),a=t.toRadians(parseFloat(n[2]));return[[Math.cos(e)*Math.cos(a),-Math.cos(r)*Math.sin(a)+Math.cos(a)*Math.sin(r)*Math.sin(e),Math.sin(r)*Math.sin(a)+Math.cos(r)*Math.cos(a)*Math.sin(e)],[Math.cos(e)*Math.sin(a),Math.cos(r)*Math.cos(a)+Math.sin(r)*Math.sin(e)*Math.sin(a),-Math.cos(a)*Math.sin(r)+Math.cos(r)*Math.sin(e)*Math.sin(a)],[-Math.sin(e),Math.cos(e)*Math.sin(r),Math.cos(r)*Math.cos(e)]]}),t.register("zxyFromQuat",function(n){return t.zxyFromMatrix(t.matrixFromQuat(t.toFloat(n)))}),t.register("quatFromZXY",function(n){return t.quatFromMatrix(t.matrixFromZXY(t.toFloat(n)))}),t.register("zyxFromQuat",function(n){return t.zyxFromMatrix(t.matrixFromQuat(t.toFloat(n)))}),t.register("quatFromZYX",function(n){return t.quatFromMatrix(t.matrixFromZYX(t.toFloat(n)))}),t.register("matrix4to3",function(n){return[[n[0][0],n[0][1],n[0][2]],[n[1][0],n[1][1],n[1][2]],[n[2][0],n[2][1],n[2][2]]]}),t.register("matrix4",function(n){return 3==n[0].length&&(n[0].push(0),n[1].push(0),n[2].push(0)),3==n.length&&n.push([0,0,0,1]),n}),t.register("composeTransform",function(n,t){return[[n[0][0],n[0][1],n[0][2],t[0]],[n[1][0],n[1][1],n[1][2],t[1]],[n[2][0],n[2][1],n[2][2],t[2]],[0,0,0,1]]}),t.register("decomposeTransform",function(n){var t=[n[0][3],n[1][3],n[2][3]],r=[n[0].slice(0,3),n[1].slice(0,3),n[2].slice(0,3)];return{rotationMatrix:r,translation:t}}),t.register("M4toArray",function(n){return[[n[0],n[4],n[8],n[12]],[n[1],n[5],n[9],n[13]],[n[2],n[6],n[10],n[14]],[n[3],n[7],n[11],n[15]]]}),t.register("ArrayToM4",function(n){return[n[0][0],n[1][0],n[2][0],n[3][0],n[0][1],n[1][1],n[2][1],n[3][1],n[0][2],n[1][2],n[2][2],n[3][2],n[0][3],n[1][3],n[2][3],n[3][3]]})}}),define("matrix",["underscore"],function(n){return function(t){t.register("add",function(n,r){return t.elementWiseIterator(t.toFloat(n),t.toFloat(r),function(n,t){return n+t})}),t.register("subtract",function(n,r){return t.elementWiseIterator(t.toFloat(n),t.toFloat(r),function(n,t){return n-t})}),t.register("eltMult",function(n,r){return t.elementWiseIterator(t.toFloat(n),t.toFloat(r),function(n,t){return n*t})}),t.register("scalarMult",function(n,r){return t.scalarIterator(t.toFloat(n),function(n){return n*parseFloat(r)})}),t.register("scalarDivide",function(n,r){return t.scalarIterator(t.toFloat(n),function(n){return n/parseFloat(r)})}),t.register("divide",t.scalarDivide),t.register("transpose",function(r){return t.is2DArray(r)?n.zip.apply(n,r):(t.throwError("can only transpose 2d arrays"),void 0)}),t.register("dot",function(n,r){return t.sum(t.eltMult(t.toFloat(n),t.toFloat(r)))}),t.register("cross",function(n,r){if(!t.isArray(n)||!t.isArray(r)||3!=n.length||3!=r.length)throw new Error("can't do a cross product with "+n+" and "+r);var e=t.toFloat(n),a=t.toFloat(r);return[e[1]*a[2]-e[2]*a[1],e[2]*a[0]-e[0]*a[2],e[0]*a[1]-e[1]*a[0]]}),t.register("eye",function(n,t){t=t||n;for(var r=[],e=0;t>e;e++){for(var a=[],i=0;n>i;i++)e==i?a.push(1):a.push(0);r.push(a)}return r}),t.register("identity",t.eye),t.register("zeros",function(n,t){t=t||n;for(var r=[],e=0;t>e;e++){for(var a=[],i=0;n>i;i++)a.push(0);r.push(a)}return r}),t.register("magnitude",function(n){return Math.sqrt(t.sum(t.toFloat(n).map(square)))}),t.register("norm",t.magnitude),t.register("normalizeColVector",function(n){return t.transpose([t.normalize(t.transpose(n)[0])])}),t.register("normalize",function(n){try{var r=t.magnitude(n);if(0==r)throw new Error("Trying to normalize a zero array");return t.divide(n,r)}catch(e){return t.normalizeColVector(n)}}),t.register("translate",function(n){var r=t.eye(4);return r[0][3]=n[0],r[1][3]=n[1],r[2][3]=n[2],r}),t.register("transformLookat",function(n,r,e){var a=t.toFloat(n),i=t.toFloat(r),o=t.toFloat(e),u=t.subtract(a,i),l=t.norm(u);u=l>1e-15?t.scalarMult(u,1/l):[0,0,1];var s=t.subtract(o,t.scalarMult(u,t.dot(u,o)));l=t.norm(s),1e-8>l&&(s=[0,1,0],s=t.subtract(s,t.scalarMult(u,t.dot(u,s))),l=t.norm(s),1e-8>l&&(s=[1,0,0],s=t.subtract(s,t.scalarMult(u,t.dot(u,s))),l=t.norm(s))),s=t.scalarMult(s,1/l);var c=t.cross(s,u),f=t.eye(4);return f[0][0]=c[0],f[0][1]=s[0],f[0][2]=u[0],f[0][3]=i[0],f[1][0]=c[1],f[1][1]=s[1],f[1][2]=u[1],f[1][3]=i[1],f[2][0]=c[2],f[2][1]=s[2],f[2][2]=u[2],f[2][3]=i[2],f}),t.register("matrixMult",function(n,r){var e=t.toFloat(n),a=t.toFloat(r);if(e[0].length!==e.length)throw t.prettyPrint(e),t.prettyPrint(a),new Error("incompatible array sizes!");for(var i=[],o=0;o<e.length;o++){for(var u=[],l=0;l<a[o].length;l++){for(var s=0,c=0;c<e[o].length;c++)s+=e[o][c]*a[c][l];u.push(s)}i.push(u)}return i}),t.register("matrixMultWithRow",function(n,r){for(var e=t.toFloat(n),a=t.toFloat(r),i=new Array(e.length),o=0;o<e.length;++o){i[o]=0;for(var u=0;u<a.length;++u)i[o]+=e[o][u]*a[u]}return i})}}),define("V3",["underscore","mjs"],function(){return function(){}}),define("M4",["underscore","mjs"],function(){return function(n){n.register("M4.matrixFromQuat",function(t){var r=n.toFloat(t),e=n.M4.clone(n.M4.I),a=n.sum(r.map(square));if(1e-8>=a)return e;var i=2/a,o=i*r[1]*r[1],u=i*r[2]*r[2],l=i*r[3]*r[3];return e[0]=1-u-l,e[1]=i*(r[1]*r[2]-r[0]*r[3]),e[2]=i*(r[1]*r[3]+r[0]*r[2]),e[4]=i*(r[1]*r[2]+r[0]*r[3]),e[5]=1-o-l,e[6]=i*(r[2]*r[3]-r[0]*r[1]),e[8]=i*(r[1]*r[3]-r[0]*r[2]),e[9]=i*(r[2]*r[3]+r[0]*r[1]),e[10]=1-o-u,e}),n.register("M4.quatFromMatrix",function(t){var r=n.toFloat(t),e=r[0],a=r[1],i=r[2],o=(r[3],r[4]),u=r[5],l=r[6],s=(r[7],r[8]),c=r[9],f=r[10],h=(r[11],e+u+f),g=[0,0,0,0];return h>=0?(g[0]=h+1,g[1]=l-c,g[2]=s-i,g[3]=a-o):u>e?f>u?(g[3]=f-(e+u)+1,g[1]=i+s,g[2]=c+l,g[0]=a-o):(g[2]=u-(f+e)+1,g[3]=c+l,g[1]=o+a,g[0]=s-i):f>e?(g[3]=f-(e+u)+1,g[1]=i+s,g[2]=c+l,g[0]=a-o):(g[1]=e-(u+f)+1,g[2]=o+a,g[3]=i+s,g[0]=l-c),n.divide(g,n.magnitude(g))}),n.register("M4.transFromMatrix",function(n){var t=new Array(3);return t[0]=n[12],t[1]=n[13],t[2]=n[14],t}),n.register("M4.composeFromQuatTrans",function(t,r){var e=n.M4.matrixFromQuat(t),a=n.toFloat(r);return 3!==a.length&&n.throwError("M4.composeFromQuatTrans: trans.length !== 3"),e[12]=a[0],e[13]=a[1],e[14]=a[2],e})}}),define("tween",["underscore"],function(){return function(n){n.register("linearlyInterpolate",function(n,t,r,e,a){return(t*(r-a)+e*(a-n))/(r-n)})}}),define("shrike",["underscore","./utils","./iterators","./base","./common","./converters","./matrix","./V3","./M4","./tween"],function(n,t,r,e,a,i,o,u,l,s){var c={};return t(c),r(c),e(c),a(c),i(c),o(c),u(c),l(c),s(c),void 0!==window.makeGlobal&&(window.makeGlobal(c),window.makeGlobal({math:c,shrike:c})),c});